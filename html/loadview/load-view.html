<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>로드뷰</title>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        #container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #roadview {
            position: absolute;
            inset: 0;
        }

        /* 좌측 하단 미니맵 */
        #miniMapWrap {
            position: absolute;
            left: 12px;
            bottom: 12px;
            width: 340px;
            height: 240px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
            border-radius: 8px;
            overflow: hidden;
            background: #fff;
            border: 1px solid rgba(0, 0, 0, 0.08);
            z-index: 2;
        }

        #miniMap {
            width: 100%;
            height: 100%;
        }

        /* 미니맵 위 컨트롤 제거 */

        /* 위치 정보 표시 */
        #locationDisplay {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-family: Arial, sans-serif;
            font-size: 13px;
            z-index: 3;
            min-width: 200px;
        }

        .location-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #3b82f6;
        }

        .location-coords {
            font-size: 12px;
            color: #fff;
            line-height: 1.4;
        }
    </style>
</head>

<body>
    <div id="container">
        <div id="roadview"></div>
        <div id="miniMapWrap">
            <div id="miniMap"></div>
        </div>
        <div id="locationDisplay">
            <div class="location-title">현재 위치</div>
            <div class="location-coords" id="currentCoords">-</div>
        </div>
    </div>


    <script>
        (function () {
            const params = new URLSearchParams(location.search);
            const lat = parseFloat(params.get('lat'));
            const lng = parseFloat(params.get('lng'));
            // Kakao Developers에서 발급받은 APP KEY를 환경에 맞춰 삽입하세요
            // 예: load-view.html?lat=..&lng=..&appkey=YOUR_APP_KEY
            const appkey = params.get('appkey') || 'b45c962cc0c0c492309ed19539227c9c';

            if (!isFinite(lat) || !isFinite(lng)) {
                console.error('잘못된 좌표입니다.');
                return;
            }

            // Kakao SDK 로드 (services 라이브러리 포함, autoload=false)
            const script = document.createElement('script');
            script.src = 'https://dapi.kakao.com/v2/maps/sdk.js?appkey=' + encodeURIComponent(appkey) + '&libraries=services&autoload=false';
            script.async = true;
            script.onload = function () {
                if (window.kakao && window.kakao.maps && window.kakao.maps.load) {
                    window.kakao.maps.load(init);
                } else {
                    init();
                }
            };
            script.onerror = function () { console.error('Kakao SDK를 불러오지 못했습니다.'); };
            document.head.appendChild(script);

            function init() {
                if (!window.kakao || !window.kakao.maps) {
                    console.error('Kakao SDK 초기화 실패');
                    return;
                }
                const position = new kakao.maps.LatLng(lat, lng);
                const roadviewContainer = document.getElementById('roadview');
                const roadview = new kakao.maps.Roadview(roadviewContainer);
                const roadviewClient = new kakao.maps.RoadviewClient();



                // 좌표를 주소로 변환하는 함수
                function getAddressFromCoords(pos, callback) {
                    const geocoder = new kakao.maps.services.Geocoder();
                    geocoder.coord2Address(pos.getLng(), pos.getLat(), function (result, status) {
                        if (status === kakao.maps.services.Status.OK) {
                            const address = result[0].address.address_name;
                            callback(address);
                        } else {
                            // 주소 변환 실패 시 좌표 표시
                            const coords = `${pos.getLat().toFixed(6)}, ${pos.getLng().toFixed(6)}`;
                            callback(coords);
                        }
                    });
                }

                // 점진적으로 검색 범위를 늘려가며 로드뷰 찾기
                function findRoadviewWithProgressiveSearch(position, callback) {
                    const searchRanges = [50, 100, 200, 500, 1000]; // 점진적으로 검색 범위 증가

                    function searchWithRange(index) {
                        if (index >= searchRanges.length) {
                            console.error('근처 로드뷰를 찾을 수 없습니다.');
                            callback(null);
                            return;
                        }

                        const range = searchRanges[index];
                        console.log(`로드뷰 검색 중... (범위: ${range}m)`);

                        roadviewClient.getNearestPanoId(position, range, function (panoId) {
                            if (panoId) {
                                console.log(`로드뷰 발견! (범위: ${range}m)`);
                                callback(panoId);
                            } else {
                                // 다음 범위로 검색
                                searchWithRange(index + 1);
                            }
                        });
                    }

                    searchWithRange(0);
                }

                // 위치 정보 업데이트 함수
                function updateLocationDisplay(pos) {
                    getAddressFromCoords(pos, function (address) {
                        document.getElementById('currentCoords').textContent = address;
                    });
                }



                // 가장 가까운 파노라마를 찾아 표시 (점진적 검색)
                findRoadviewWithProgressiveSearch(position, function (panoId) {
                    if (panoId) {
                        roadview.setPanoId(panoId, position);
                        // 초기 위치 표시
                        updateLocationDisplay(position);
                    }
                });

                // URL에서 줌 레벨 가져오기 (기본값: 4)
                const zoomLevel = parseInt(params.get('zoom')) || 4;

                // 좌측 하단 미니맵 생성 (전달받은 줌 레벨 적용)
                const miniMap = new kakao.maps.Map(document.getElementById('miniMap'), {
                    center: position,
                    level: zoomLevel,
                    mapTypeId: kakao.maps.MapTypeId.ROADMAP,
                });

                // 로드뷰 커버리지(파란 영역) 표시
                miniMap.addOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);
                // 필요 시 기본 지도 타입 컨트롤 추가
                const mapTypeControl = new kakao.maps.MapTypeControl();
                miniMap.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);

                // 제공된 스프라이트 마커 이미지 사용
                var markImage = new kakao.maps.MarkerImage(
                    'https://t1.daumcdn.net/localimg/localimages/07/2018/pc/roadview_minimap_wk_2018.png',
                    new kakao.maps.Size(26, 46),
                    {
                        spriteSize: new kakao.maps.Size(1666, 168),
                        spriteOrigin: new kakao.maps.Point(705, 114),
                        offset: new kakao.maps.Point(13, 46)
                    }
                );
                const marker = new kakao.maps.Marker({ position, image: markImage, draggable: true });
                marker.setMap(miniMap);

                // 미니맵 클릭 시 로드뷰 이동 및 마커/중심 동기화 (줌 레벨 유지)
                kakao.maps.event.addListener(miniMap, 'click', function (mouseEvent) {
                    const newPos = mouseEvent.latLng;
                    marker.setPosition(newPos);
                    miniMap.setCenter(newPos);
                    // 줌 레벨 유지
                    miniMap.setLevel(zoomLevel);
                    findRoadviewWithProgressiveSearch(newPos, function (panoId) {
                        if (panoId) {
                            roadview.setPanoId(panoId, newPos);
                            // 현재 위치 표시 업데이트
                            updateLocationDisplay(newPos);
                        }
                    });
                });

                // 마커 드래그 종료 시 로드뷰 이동 (줌 레벨 유지)
                kakao.maps.event.addListener(marker, 'dragend', function () {
                    const newPos = marker.getPosition();
                    miniMap.setCenter(newPos);
                    // 줌 레벨 유지
                    miniMap.setLevel(zoomLevel);
                    findRoadviewWithProgressiveSearch(newPos, function (panoId) {
                        if (panoId) {
                            roadview.setPanoId(panoId, newPos);
                            // 현재 위치 표시 업데이트
                            updateLocationDisplay(newPos);
                        }
                    });
                });

                // 로드뷰 이동 시 마커/미니맵 동기화 (줌 레벨 유지)
                kakao.maps.event.addListener(roadview, 'position_changed', function () {
                    const pos = roadview.getPosition();
                    marker.setPosition(pos);
                    miniMap.setCenter(pos);
                    // 줌 레벨 유지
                    miniMap.setLevel(zoomLevel);
                    // 현재 위치 표시 업데이트
                    updateLocationDisplay(pos);
                });


            }
        })();
    </script>
</body>

</html>