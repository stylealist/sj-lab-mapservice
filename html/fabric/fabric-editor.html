<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <title>ÏßÄÎèÑ Ìé∏ÏßëÍ∏∞</title>
    <style>
        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            color: #334155;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #container {
            height: calc(100vh - 80px);
            width: 100%;
            display: flex;
            overflow: hidden;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin: 8px;
            border: 1px solid #e2e8f0;
        }

        #container.scrollable {
            overflow: auto !important;
        }

        #canvasContainer {
            flex: 1;
            position: relative;
            height: 100%;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 0;
            background: #f8fafc;
            border-radius: 0 12px 12px 0;
        }

        #canvasContainer.scrollable {
            overflow: auto !important;
        }

        .canvas-container {
            position: relative !important;
        }

        #canvas {
            background-color: #ffffff;
            border: 2px solid #e2e8f0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            display: block;
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
        }

        #toolbar {
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            padding: 16px 20px;
            background: linear-gradient(135deg, rgb(30, 41, 59) 0%, rgb(51, 65, 85) 50%, rgb(71, 85, 105) 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            z-index: 10;
            min-height: 70px;
            box-sizing: border-box;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
        }

        #toolbar .group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        #toolbar button {
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            color: #334155;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 100px;
            justify-content: center;
        }

        #toolbar button:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        #toolbar button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 700;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        #toolbar button:active {
            transform: translateY(0);
        }

        /* Îã®Ï∂ïÌÇ§ ÎèÑÏõÄÎßê Ïä§ÌÉÄÏùº */
        .shortcut-help {
            position: relative;
            display: inline-block;
            cursor: help;
            margin-left: 8px;
            z-index: 1001;
        }

        .help-icon {
            font-size: 16px;
            padding: 8px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 6px;
            display: inline-block;
            transition: background 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .help-icon:hover {
            background-color: #e8f0ff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .shortcut-tooltip {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 0;
            border-radius: 8px;
            font-size: 13px;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            min-width: 250px;
            margin-top: 8px;
            pointer-events: none;
        }

        .shortcut-help:hover .shortcut-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .shortcut-tooltip::before {
            content: "";
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
        }

        .shortcut-tooltip::before {
            top: -6px;
            border-bottom: 6px solid #333;
        }

        .shortcut-tooltip[style*="--arrow-direction: bottom"]::before {
            top: auto;
            bottom: -6px;
            border-bottom: none;
            border-top: 6px solid #333;
        }

        .tooltip-header {
            background: #007bff;
            color: white;
            padding: 10px 15px;
            font-weight: bold;
            border-radius: 8px 8px 0 0;
            text-align: center;
            font-size: 14px;
        }

        /* Ï∫îÎ≤ÑÏä§ Î¶¨ÏÇ¨Ïù¥Ï¶à Ìï∏Îì§ */
        .canvas-resize-handle {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #007bff;
            border: 2px solid white;
            border-radius: 50%;
            cursor: se-resize;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        .canvas-resize-handle:hover {
            background: #0056b3;
            transform: scale(1.1);
        }

        .canvas-resize-handle::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 1px;
        }

        .canvas-resize-handle::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            width: 12px;
            height: 2px;
            background: white;
            border-radius: 1px;
        }

        .tooltip-content {
            padding: 12px 15px;
        }

        .shortcut-item {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
        }

        .shortcut-item:last-child {
            margin-bottom: 0;
        }

        .shortcut-item kbd {
            background: #2c3e50;
            border: 1px solid #34495e;
            border-radius: 4px;
            padding: 4px 10px;
            font-size: 12px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                "Helvetica Neue", Arial, sans-serif;
            min-width: 60px;
            text-align: center;
            display: inline-block;
            font-weight: 600;
            color: #ffffff;
            text-shadow: none;
            letter-spacing: 0.5px;
            line-height: 1.2;
        }

        #coordDisplay {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        #layerList {
            position: sticky;
            top: 0;
            right: 0;
            width: 300px;
            min-width: 250px;
            max-width: 360px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-left: 1px solid #e2e8f0;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            font-size: 14px;
            box-sizing: border-box;
            padding: 20px;
            flex-shrink: 0;
        }

        #layerList strong {
            display: block;
            margin-bottom: 16px;
            font-size: 18px;
            color: #1f2937;
            font-weight: 700;
            text-align: center;
            padding: 12px;
            background: linear-gradient(135deg, rgb(30, 41, 59) 0%, rgb(51, 65, 85) 50%, rgb(71, 85, 105) 100%);
            color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        #layerList .layer-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #layerList .layer-item:hover {
            background: #f8fafc;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }

        #layerList .layer-label {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        #layerList .layer-buttons {
            display: flex;
            gap: 8px;
        }

        #layerList button {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #4b5563;
            flex: 1;
        }

        #layerList button:hover {
            background: #667eea;
            border-color: #667eea;
            color: white;
            transform: translateY(-1px);
        }

        #layerList button:first-child:hover {
            background: #10b981;
            border-color: #10b981;
        }

        #layerList button:last-child:hover {
            background: #ef4444;
            border-color: #ef4444;
        }

        #layerList::-webkit-scrollbar {
            width: 8px;
        }

        #layerList::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 6px;
        }

        #layerList::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 6px;
        }

        #layerList .layer-item.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #e0e7ff 0%, #f0f4ff 100%);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
        }

        #shapeProperties {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 240px;
            min-width: 225px;
            background: white;
            border: none;
            border-radius: 16px;
            font-size: 14px;
            display: none;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            z-index: 99999;
            cursor: move;
            user-select: none;
            max-height: 500px;
            overflow: visible;
            backdrop-filter: blur(10px);
        }

        #shapeProperties .header {
            cursor: move;
            padding: 15px 15px 12px 15px;
            border-bottom: 1px solid #f1f5f9;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px 16px 0 0;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        #shapeProperties .body {
            max-height: 350px;
            overflow-y: auto;
            padding: 15px;
            background: #fafbfc;
        }

        #shapeProperties .header strong {
            display: inline-block;
            margin-right: 20px;
            color: white;
            font-weight: 700;
            font-size: 16px;
        }

        #shapeProperties .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        #shapeProperties .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        #shapeProperties .property-group {
            margin-bottom: 15px;
            cursor: default;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px;
            background: white;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        #shapeProperties .property-group::before {
            content: attr(data-label);
            position: absolute;
            top: -8px;
            left: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #shapeProperties .property-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 13px;
            margin-top: 6px;
        }

        #shapeProperties input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 13px;
            cursor: text;
            background: white;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        #shapeProperties input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #shapeProperties input[type="color"] {
            height: 40px;
            padding: 4px;
            cursor: pointer;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }

        #shapeProperties .style-btn {
            width: 100%;
            padding: 12px 16px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #4b5563;
        }

        #shapeProperties .style-btn:hover {
            background: #e2e8f0;
            border-color: #667eea;
            transform: translateY(-1px);
        }

        #shapeProperties .style-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .color-btn {
            width: 36px;
            height: 36px;
            border: 3px solid #e5e7eb;
            border-radius: 10px;
            cursor: pointer;
            outline: none;
            padding: 0;
            box-sizing: border-box;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .color-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .color-btn:focus {
            border: 3px solid #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }

        .styled-btn {
            display: inline-block;
            width: 100%;
            padding: 12px 16px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            color: #4b5563;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            margin-bottom: 8px;
        }

        .styled-btn:hover,
        .styled-btn:focus {
            background: #667eea;
            border-color: #667eea;
            color: white;
            outline: none;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .color-palette-popup {
            background: white;
            border: none;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            padding: 16px;
            position: fixed;
            z-index: 9999;
            display: none;
            width: auto;
            backdrop-filter: blur(10px);
        }

        .palette-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            justify-content: flex-start;
            background: none;
            border: none;
            box-shadow: none;
            padding: 0;
        }

        #shapeProperties .property-group#zOrderSection button {
            margin-right: 8px;
        }

        #shapeProperties .property-group#zOrderSection button:last-child {
            margin-right: 0;
        }

        /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
        @media (max-width: 1200px) {
            #layerList {
                width: 250px;
                min-width: 200px;
            }

            #shapeProperties {
                width: 220px;
            }
        }

        @media (max-width: 768px) {
            #container {
                flex-direction: column;
                height: calc(100vh - 60px);
            }

            #layerList {
                width: 100%;
                height: 200px;
                border-left: none;
                border-top: 1px solid #e2e8f0;
                order: 2;
            }

            #canvasContainer {
                order: 1;
                border-radius: 12px 12px 0 0;
            }

            #toolbar {
                padding: 12px 16px;
                gap: 12px;
            }

            #toolbar .group {
                padding: 6px 12px;
                gap: 8px;
            }

            #toolbar button {
                padding: 8px 12px;
                font-size: 13px;
                min-width: 80px;
            }
        }

        @media (max-width: 480px) {
            #toolbar {
                flex-direction: column;
                gap: 8px;
            }

            #toolbar .group {
                justify-content: center;
                flex-wrap: wrap;
            }

            #toolbar button {
                min-width: 70px;
                font-size: 12px;
                padding: 6px 10px;
            }
        }

        /* ÌåùÏóÖ ÏµúÏ†ÅÌôî */
        .modal-back {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            backdrop-filter: blur(5px);
        }

        /* Ïï†ÎãàÎ©îÏù¥ÏÖò Ìö®Í≥º */
        #shapeProperties {
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .color-palette-popup {
            animation: fadeInScale 0.2s ease-out;
        }

        @keyframes fadeInScale {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Ìò∏Î≤Ñ Ìö®Í≥º Í∞úÏÑ† */
        #toolbar button:hover {
            transform: translateY(-2px) scale(1.02);
        }

        #layerList .layer-item:hover {
            transform: translateY(-2px) scale(1.02);
        }

        .color-btn:hover {
            transform: scale(1.15);
        }

        /* Ìè¨Ïª§Ïä§ Ïä§ÌÉÄÏùº Í∞úÏÑ† */
        #toolbar button:focus,
        #layerList button:focus,
        .styled-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }

        /* Ïä§ÌÅ¨Î°§Î∞î Ïä§ÌÉÄÏùº ÌÜµÏùº */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }
    </style>
</head>

<body>
    <div id="toolbar">
        <div class="group">
            <input type="file" id="bgImageInput" accept="image/*" style="display: none" />
            <button id="btn-pan" onclick="setMode('pan')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                </svg>
                Ìå¨
            </button>
            <button id="btn-line" onclick="setMode('line')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 3h18v2H3V3zm0 4h18v2H3V7zm0 4h18v2H3v-2zm0 4h18v2H3v-2z" />
                </svg>
                ÏßÅÏÑ†
            </button>
            <button id="btn-circle" onclick="setMode('circle')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" />
                </svg>
                Ïõê
            </button>
            <button id="btn-rect" onclick="setMode('rect')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="3" y="3" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" />
                </svg>
                ÏÇ¨Í∞ÅÌòï
            </button>
            <button id="btn-triangle" onclick="setMode('triangle')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2l9 18H3l9-18z" stroke="currentColor" stroke-width="2" fill="none" />
                </svg>
                ÏÇºÍ∞ÅÌòï
            </button>
            <button id="btn-arrow" onclick="setMode('arrow')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                </svg>
                ÏπòÏàòÏÑ†
            </button>
            <button onclick="addText()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M5 4v3h5.5v12h3V7H19V4H5z" />
                </svg>
                ÌÖçÏä§Ìä∏
            </button>
        </div>
        <div class="group">
            <button onclick="document.getElementById('bgImageInput').click()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" />
                </svg>
                Ïù¥ÎØ∏ÏßÄ
            </button>
            <button onclick="clearLayers()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />
                </svg>
                Ï¥àÍ∏∞Ìôî
            </button>
            <button id="fabricSave" onclick="saveImage();">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V7h10v2z" />
                </svg>
                Ï†ÄÏû•
            </button>
        </div>
        <div class="group">
            <div class="shortcut-help" title="Îã®Ï∂ïÌÇ§ ÎèÑÏõÄÎßê">
                <span class="help-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z" />
                    </svg>
                </span>
                <div class="shortcut-tooltip">
                    <div class="tooltip-header">Îã®Ï∂ïÌÇ§ ÎèÑÏõÄÎßê</div>
                    <div class="tooltip-content">
                        <div class="shortcut-item">
                            <kbd>Delete</kbd> ÏÑ†ÌÉùÎêú Í∞ùÏ≤¥ ÏÇ≠Ï†ú
                        </div>
                        <div class="shortcut-item"><kbd>Esc</kbd> ÏÑ†ÌÉù Ìï¥Ï†ú</div>
                        <div class="shortcut-item"><kbd>Ctrl+A</kbd> Î™®Îì† Í∞ùÏ≤¥ ÏÑ†ÌÉù</div>
                        <div class="shortcut-item"><kbd>Ctrl+C</kbd> Î≥µÏÇ¨</div>
                        <div class="shortcut-item"><kbd>Ctrl+V</kbd> Î∂ôÏó¨ÎÑ£Í∏∞</div>
                        <div class="shortcut-item"><kbd>Ctrl+Z</kbd> ÎêòÎèåÎ¶¨Í∏∞</div>
                        <div class="shortcut-item">
                            <kbd>ÎèÑÌòï Ïö∞ÌÅ¥Î¶≠</kbd> ÏÜçÏÑ± Ìé∏Ïßë ÌåùÏóÖ
                        </div>
                        <div class="shortcut-item"><kbd>Ctrl + Ìú†</kbd> ÌôïÎåÄ/Ï∂ïÏÜå</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="container">
        <div id="canvasContainer">
            <canvas id="canvas"></canvas>
            <div id="coordDisplay">x: 0, y: 0</div>
        </div>
        <div id="layerList"><strong>Î†àÏù¥Ïñ¥ Î™©Î°ù</strong></div>
        <div id="shapeProperties">
            <div class="header">
                <strong>ÏÜçÏÑ± Ìé∏Ïßë</strong>
                <button class="close-btn" onclick="hideShapeProperties()">√ó</button>
            </div>
            <div class="body">
                <div class="property-group" id="strokeColorSection" data-label="ÏÉâÏÉÅ ÏÑ§Ï†ï">
                    <label id="strokeColorLabel">ÏÑ† ÏÉâÏÉÅ:</label>
                    <div style="
                display: flex;
                gap: 8px;
                margin-bottom: 8px;
                position: relative;
              ">
                        <button class="palette-trigger styled-btn" id="strokeThemeBtn" style="flex: 1">
                            ÌÖåÎßàÏÉâ
                        </button>
                        <button class="palette-trigger styled-btn" id="strokeStandardBtn" style="flex: 1">
                            ÌëúÏ§ÄÏÉâ
                        </button>
                        <div class="color-palette-popup" id="strokeThemePalette" style="display: none;">
                            <div class="palette-row">
                                <button class="color-btn" data-color="#ffffff" style="background: #ffffff"></button>
                                <button class="color-btn" data-color="#f2f2f2" style="background: #f2f2f2"></button>
                                <button class="color-btn" data-color="#e7e6e6" style="background: #e7e6e6"></button>
                                <button class="color-btn" data-color="#44546a" style="background: #44546a"></button>
                            </div>
                            <div class="palette-row">
                                <button class="color-btn" data-color="#4472c4" style="background: #4472c4"></button>
                                <button class="color-btn" data-color="#ed7d31" style="background: #ed7d31"></button>
                                <button class="color-btn" data-color="#70ad47" style="background: #70ad47"></button>
                                <button class="color-btn" data-color="#a5a5a5" style="background: #a5a5a5"></button>
                            </div>
                            <div class="palette-row">
                                <button class="color-btn" data-color="#ffc000" style="background: #ffc000"></button>
                                <button class="color-btn" data-color="#5b9bd5" style="background: #5b9bd5"></button>
                                <button class="color-btn" data-color="#c00000" style="background: #c00000"></button>
                                <button class="color-btn" data-color="#548235" style="background: #548235"></button>
                            </div>
                        </div>
                        <div class="color-palette-popup" id="strokeStandardPalette" style="display: none;">
                            <div class="palette-row">
                                <button class="color-btn" data-color="#ff0000" style="background: #ff0000"></button>
                                <button class="color-btn" data-color="#ffff00" style="background: #ffff00"></button>
                                <button class="color-btn" data-color="#00b050" style="background: #00b050"></button>
                                <button class="color-btn" data-color="#00b0f0" style="background: #00b0f0"></button>
                            </div>
                            <div class="palette-row">
                                <button class="color-btn" data-color="#0070c0" style="background: #0070c0"></button>
                                <button class="color-btn" data-color="#002060" style="background: #002060"></button>
                                <button class="color-btn" data-color="#7030a0" style="background: #7030a0"></button>
                                <button class="color-btn" data-color="#000000" style="background: #000000"></button>
                            </div>
                        </div>
                    </div>
                    <input type="color" id="strokeColor" value="#FF0000" />
                </div>
                <div class="property-group" id="textBackgroundSection" data-label="ÌÖçÏä§Ìä∏ Î∞∞Í≤Ω ÏÑ§Ï†ï" style="display: none">
                    <label id="textBackgroundLabel">ÌÖçÏä§Ìä∏ Î∞∞Í≤ΩÏÉâ:</label>
                    <div style="
                display: flex;
                gap: 8px;
                margin-bottom: 8px;
                position: relative;
              ">
                        <button class="palette-trigger styled-btn" id="textBackgroundThemeBtn" style="flex: 1">
                            ÌÖåÎßàÏÉâ
                        </button>
                        <button class="palette-trigger styled-btn" id="textBackgroundStandardBtn" style="flex: 1">
                            ÌëúÏ§ÄÏÉâ
                        </button>
                        <div class="color-palette-popup" id="textBackgroundThemePalette" style="display: none;">
                            <div class="palette-row">
                                <button class="color-btn" data-color="#ffffff" style="background: #ffffff"></button>
                                <button class="color-btn" data-color="#f2f2f2" style="background: #f2f2f2"></button>
                                <button class="color-btn" data-color="#e7e6e6" style="background: #e7e6e6"></button>
                                <button class="color-btn" data-color="#44546a" style="background: #44546a"></button>
                            </div>
                            <div class="palette-row">
                                <button class="color-btn" data-color="#4472c4" style="background: #4472c4"></button>
                                <button class="color-btn" data-color="#ed7d31" style="background: #ed7d31"></button>
                                <button class="color-btn" data-color="#70ad47" style="background: #70ad47"></button>
                                <button class="color-btn" data-color="#a5a5a5" style="background: #a5a5a5"></button>
                            </div>
                            <div class="palette-row">
                                <button class="color-btn" data-color="#ffc000" style="background: #ffc000"></button>
                                <button class="color-btn" data-color="#5b9bd5" style="background: #5b9bd5"></button>
                                <button class="color-btn" data-color="#c00000" style="background: #c00000"></button>
                                <button class="color-btn" data-color="#548235" style="background: #548235"></button>
                            </div>
                        </div>
                        <div class="color-palette-popup" id="textBackgroundStandardPalette" style="display: none;">
                            <div class="palette-row">
                                <button class="color-btn" data-color="#ff0000" style="background: #ff0000"></button>
                                <button class="color-btn" data-color="#ffff00" style="background: #ffff00"></button>
                                <button class="color-btn" data-color="#00b050" style="background: #00b050"></button>
                                <button class="color-btn" data-color="#00b0f0" style="background: #00b0f0"></button>
                            </div>
                            <div class="palette-row">
                                <button class="color-btn" data-color="#0070c0" style="background: #0070c0"></button>
                                <button class="color-btn" data-color="#002060" style="background: #002060"></button>
                                <button class="color-btn" data-color="#7030a0" style="background: #7030a0"></button>
                                <button class="color-btn" data-color="#000000" style="background: #000000"></button>
                            </div>
                        </div>
                    </div>
                    <input type="color" id="textBackgroundColor" value="#FFFFFF" />
                    <button id="textBackgroundTransparentBtn" class="style-btn" style="margin-top: 5px">
                        Î∞∞Í≤ΩÏóÜÏùå
                    </button>
                </div>
                <div class="property-group" id="strokeWidthSection" data-label="ÌÅ¨Í∏∞ ÏÑ§Ï†ï">
                    <label>ÏÑ† ÎëêÍªò:</label>
                    <input type="number" id="strokeWidth" min="1" max="20" value="2" />
                </div>
                <div class="property-group" id="fillSection" data-label="Ï±ÑÏö∞Í∏∞ ÏÑ§Ï†ï">
                    <label>Ï±ÑÏö∞Í∏∞ ÏÉâÏÉÅ:</label>
                    <div style="
                display: flex;
                gap: 8px;
                margin-bottom: 8px;
                position: relative;
              ">
                        <button class="palette-trigger styled-btn" id="fillThemeBtn" style="flex: 1">
                            ÌÖåÎßàÏÉâ
                        </button>
                        <button class="palette-trigger styled-btn" id="fillStandardBtn" style="flex: 1">
                            ÌëúÏ§ÄÏÉâ
                        </button>
                        <div class="color-palette-popup" id="fillThemePalette" style="display: none;">
                            <div class="palette-row">
                                <button class="color-btn" data-color="#ffffff" style="background: #ffffff"></button>
                                <button class="color-btn" data-color="#f2f2f2" style="background: #f2f2f2"></button>
                                <button class="color-btn" data-color="#e7e6e6" style="background: #e7e6e6"></button>
                                <button class="color-btn" data-color="#44546a" style="background: #44546a"></button>
                            </div>
                            <div class="palette-row">
                                <button class="color-btn" data-color="#4472c4" style="background: #4472c4"></button>
                                <button class="color-btn" data-color="#ed7d31" style="background: #ed7d31"></button>
                                <button class="color-btn" data-color="#70ad47" style="background: #70ad47"></button>
                                <button class="color-btn" data-color="#a5a5a5" style="background: #a5a5a5"></button>
                            </div>
                            <div class="palette-row">
                                <button class="color-btn" data-color="#ffc000" style="background: #ffc000"></button>
                                <button class="color-btn" data-color="#5b9bd5" style="background: #5b9bd5"></button>
                                <button class="color-btn" data-color="#c00000" style="background: #c00000"></button>
                                <button class="color-btn" data-color="#548235" style="background: #548235"></button>
                            </div>
                        </div>
                        <div class="color-palette-popup" id="fillStandardPalette" style="display: none;">
                            <div class="palette-row">
                                <button class="color-btn" data-color="#ff0000" style="background: #ff0000"></button>
                                <button class="color-btn" data-color="#ffff00" style="background: #ffff00"></button>
                                <button class="color-btn" data-color="#00b050" style="background: #00b050"></button>
                                <button class="color-btn" data-color="#00b0f0" style="background: #00b0f0"></button>
                            </div>
                            <div class="palette-row">
                                <button class="color-btn" data-color="#0070c0" style="background: #0070c0"></button>
                                <button class="color-btn" data-color="#002060" style="background: #002060"></button>
                                <button class="color-btn" data-color="#7030a0" style="background: #7030a0"></button>
                                <button class="color-btn" data-color="#000000" style="background: #000000"></button>
                            </div>
                        </div>
                    </div>
                    <input type="color" id="fillColor" value="#FFFFFF" />
                    <button id="transparentBtn" class="style-btn" style="margin-top: 5px">
                        Ï±ÑÏö∞Í∏∞ÏóÜÏùå
                    </button>
                </div>
                <div class="property-group" id="dashedSection" data-label="Ïä§ÌÉÄÏùº ÏÑ§Ï†ï">
                    <label>ÏÑ† Ïä§ÌÉÄÏùº:</label>
                    <button id="dashedToggle" class="style-btn">Ïã§ÏÑ†</button>
                </div>
                <div class="property-group" id="zOrderSection" data-label="Î†àÏù¥Ïñ¥ ÏàúÏÑú">
                    <button id="bringToFrontBtn" class="style-btn" style="margin-bottom: 10px">
                        Îß®ÏúÑÎ°ú
                    </button>
                    <button id="sendToBackBtn" class="style-btn">Îß®ÏïÑÎûòÎ°ú</button>
                </div>
            </div>
        </div>
    </div>
    <!-- ÌååÏùº Ïù¥Î¶Ñ ÏûÖÎ†• Î™®Îã¨ -->
    <!-- Î™®Îã¨ ÌåùÏóÖ -->
    <div id="saveModal" style="
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border: none;
        border-radius: 20px;
        padding: 32px;
        z-index: 9999;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        width: 400px;
        font-family: 'Segoe UI', sans-serif;
        backdrop-filter: blur(10px);
      ">
        <div style="
          margin-bottom: 24px;
          font-weight: 700;
          color: #1f2937;
          font-size: 20px;
          text-align: center;
        ">
            üíæ Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû•
        </div>

        <div style="margin-bottom: 20px;">
            <label style="
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        ">ÌååÏùºÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî</label>
            <input id="fabricFileName" type="text" placeholder="Ïòà: my-image" style="
          width: 100%;
          padding: 12px 16px;
          font-size: 14px;
          border: 2px solid #e5e7eb;
          border-radius: 12px;
          background: #f8fafc;
          transition: all 0.3s ease;
        " autocomplete="off" />
        </div>

        <div style="margin-top: 24px; text-align: right; display: flex; gap: 12px; justify-content: flex-end">
            <button onclick="closeSaveModal()" style="
            background: #f3f4f6;
            color: #374151;
            border: 2px solid #e5e7eb;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
          ">
                Ï∑®ÏÜå
            </button>

            <button onclick="downloadCanvasImage()" style="
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
          ">
                üíæ Ï†ÄÏû•ÌïòÍ∏∞
            </button>
        </div>
    </div>
    <div id="fabric-back" class="modal-back" style="display: none"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script>
        (function () {
            const fabricType = "";
            const fabricCanvas = new fabric.Canvas("canvas");
            window.fabricCanvas = fabricCanvas;

            // Ïª®Ìä∏Î°§ Î∞ïÏä§ ÏúÑÏπò ÏàòÏ†ï ÏÑ§Ï†ï
            fabric.Object.prototype.transparentCorners = false;
            fabric.Object.prototype.cornerColor = '#4169E1';
            fabric.Object.prototype.cornerStyle = 'circle';
            fabric.Object.prototype.cornerSize = 8;
            fabric.Object.prototype.borderColor = '#4169E1';
            fabric.Object.prototype.borderDashArray = [5, 5];

            // Ïª®Ìä∏Î°§Îü¨ ÏúÑÏπò Ïò§ÌîÑÏÖã ÏàòÏ†ï
            fabric.Object.prototype.padding = 0;
            fabric.Canvas.prototype.uniformScaling = false;

            fabricCanvas.on("object:added", function (e) {
                const textObjects = fabricCanvas
                    .getObjects("text")
                    .concat(fabricCanvas.getObjects("i-text"));
                textObjects.forEach((obj) => fabricCanvas.bringToFront(obj));

                // ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú Í∞ùÏ≤¥Ïùò Ïª®Ìä∏Î°§ ÏúÑÏπò Î≥¥Ï†ï
                if (e.target) {
                    e.target.setCoords();
                }
            });

            fabricCanvas.on("selection:created", function (e) {
                if (
                    e.target &&
                    (e.target.type === "text" || e.target.type === "i-text")
                ) {
                    fabricCanvas.bringToFront(e.target);
                }

                // ÏÑ†ÌÉùÎêú Í∞ùÏ≤¥Ïùò Ïª®Ìä∏Î°§ ÏúÑÏπò Î≥¥Ï†ï
                if (e.target) {
                    e.target.setCoords();
                    fabricCanvas.renderAll();
                }
            });

            // Í∞ùÏ≤¥ ÏÑ†ÌÉù Î≥ÄÍ≤Ω Ïãú Ïª®Ìä∏Î°§ ÏúÑÏπò Î≥¥Ï†ï
            fabricCanvas.on("selection:updated", function (e) {
                if (e.target) {
                    e.target.setCoords();
                    fabricCanvas.renderAll();
                }
            });

            // Í∞ùÏ≤¥ Ïù¥Îèô/Î≥ÄÌòï ÌõÑ Ïª®Ìä∏Î°§ ÏúÑÏπò Î≥¥Ï†ï
            fabricCanvas.on("object:modified", function (e) {
                if (e.target) {
                    e.target.setCoords();
                    fabricCanvas.renderAll();
                }
            });

            // canvas Ï¥àÍ∏∞ ÌÅ¨Í∏∞Î•º Ïª®ÌÖåÏù¥ÎÑàÏóê ÎßûÍ≤å ÏÑ§Ï†ï
            function initializeCanvasSize() {
                const container = document.getElementById("canvasContainer");
                const containerWidth = container.clientWidth;
                const containerHeight = container.clientHeight;

                // Í∏∞Î≥∏ ÌÅ¨Í∏∞Î•º Ïª®ÌÖåÏù¥ÎÑàÎ≥¥Îã§ ÏûëÍ≤å ÏÑ§Ï†ï (Ïó¨Ïú† Í≥µÍ∞Ñ 100px)
                const defaultWidth = Math.max(400, containerWidth - 100);
                const defaultHeight = Math.max(300, containerHeight - 100);

                fabricCanvas.setWidth(defaultWidth);
                fabricCanvas.setHeight(defaultHeight);
                fabricCanvas.perPixelTargetFind = false;

                // Ïª®Ìä∏Î°§Îü¨ ÏúÑÏπò Ïò§ÌîÑÏÖã ÏàòÏ†ïÏùÑ ÏúÑÌïú Ï∂îÍ∞Ä ÏÑ§Ï†ï
                fabricCanvas.on('after:render', function () {
                    // Ï∫îÎ≤ÑÏä§Í∞Ä Î†åÎçîÎßÅÎêú ÌõÑ Ïª®Ìä∏Î°§ ÏúÑÏπòÎ•º Îã§Ïãú Í≥ÑÏÇ∞
                    const activeObject = fabricCanvas.getActiveObject();
                    if (activeObject) {
                        activeObject.setCoords();
                    }
                });

                fabricCanvas.renderAll();
            }

            let currentMode = "none";
            let isDrawing = false;
            let startX, startY, currentShape;
            let history = [],
                lastSavedJSON = "";
            // ÎßàÏö∞Ïä§ Ìú†Î°ú ÎßàÏö∞Ïä§ ÏúÑÏπò Í∏∞Ï§Ä ÌôïÎåÄ/Ï∂ïÏÜå
            let zoom = 1;
            const minZoom = 1;
            const maxZoom = 5;
            // ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞ Ï†ÄÏû•
            let fabricImgWidth = 0;
            let fabricImgHeight = 0;

            // canvas Ï¥àÍ∏∞ ÌÅ¨Í∏∞ ÏÑ§Ï†ï
            initializeCanvasSize();

            // Ïª®ÌÖåÏù¥ÎÑà ÌÅ¨Í∏∞ ÎèôÏ†Å Ï°∞Ï†ïÏùÄ CSSÎ°ú Ï≤òÎ¶¨ÌïòÎØÄÎ°ú Ï†úÍ±∞

            // ÏµúÏ¥à ÏÉÅÌÉúÎ•º ÌûàÏä§ÌÜ†Î¶¨Ïóê Ï†ÄÏû• (Ctrl+ZÎ°ú ÏµúÏ¥à ÎèÑÌòïÎèÑ ÏôÑÏ†ÑÌûà ÎêòÎèåÎ¶¨Í∏∞ ÏúÑÌï®)
            saveHistory();

            // Ïª®Ìä∏Î°§ ÏúÑÏπò Ï†ÑÏ≤¥ Î≥¥Ï†ï Ìï®Ïàò
            function fixControlsPosition() {
                fabricCanvas.getObjects().forEach(function (obj) {
                    obj.setCoords();
                });
                fabricCanvas.renderAll();
            }

            // Ï¥àÍ∏∞ Ïª®Ìä∏Î°§ ÏúÑÏπò Î≥¥Ï†ï
            setTimeout(fixControlsPosition, 100);

            fabricCanvas.on("mouse:wheel", function (opt) {
                // Ctrl ÌÇ§Í∞Ä ÎàåÎ†§ÏûàÏùÑ ÎïåÎßå ÌôïÎåÄ/Ï∂ïÏÜå
                if (!opt.e.ctrlKey) return;

                const delta = opt.e.deltaY;
                let zoomFactor = zoom;
                zoomFactor *= 0.999 ** delta;
                zoomFactor = Math.max(minZoom, Math.min(maxZoom, zoomFactor));
                const pointer = fabricCanvas.getPointer(opt.e);
                fabricCanvas.zoomToPoint(
                    { x: opt.e.offsetX, y: opt.e.offsetY },
                    zoomFactor
                );
                zoom = zoomFactor;
                opt.e.preventDefault();
                opt.e.stopPropagation();

                // ÌôïÎåÄ/Ï∂ïÏÜå ÌõÑ Í≥µÎ∞± Î∞©ÏßÄ: Ï¢åÏÉÅÎã®Ïù¥ Ìï≠ÏÉÅ (0,0)Ïóê Ïò§ÎèÑÎ°ù Ïù¥Îèô
                const vpt = fabricCanvas.viewportTransform;
                if (vpt[4] > 0) vpt[4] = 0;
                if (vpt[5] > 0) vpt[5] = 0;
                const canvasWidth = fabricCanvas.getWidth();
                const canvasHeight = fabricCanvas.getHeight();
                const zoomedWidth = canvasWidth * zoom;
                const zoomedHeight = canvasHeight * zoom;
                if (zoomedWidth + vpt[4] < canvasWidth)
                    vpt[4] = canvasWidth - zoomedWidth;
                if (zoomedHeight + vpt[5] < canvasHeight)
                    vpt[5] = canvasHeight - zoomedHeight;
                fabricCanvas.requestRenderAll();
            });

            // ÎìúÎûòÍ∑∏ Í¥ÄÎ†® Î≥ÄÏàò
            let isDragging = false;
            let dragStartX, dragStartY;
            let originalLeft, originalTop;

            const objectCounters = {
                pan: 0,
                line: 0,
                circle: 0,
                rect: 0,
                triangle: 0,
                textbox: 0,
                arrow: 0,
            };

            // Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄÍ∞Ä Íπ®ÏßÄÏßÄ ÏïäÎäî ÎπÑÏú®Î°ú ÏµúÎåÄÌïú canvasContainerÏóê ÎßûÍ≤å Ï§ëÏïôÏóê Ïò§ÎèÑÎ°ù
            function fitImageToContainer() {
                const container = document.getElementById("canvasContainer");
                const maxWidth = container.clientWidth;
                const maxHeight = container.clientHeight;
                const img = fabricCanvas.backgroundImage;

                if (img) {
                    // ÏõêÎ≥∏ ÌÅ¨Í∏∞ Ïú†ÏßÄ (Î¶¨ÏÇ¨Ïù¥Ïßï ÏãúÏóêÎèÑ)
                    let newWidth = img.width;
                    let newHeight = img.height;

                    // Ïª®ÌÖåÏù¥ÎÑàÎ•º Î≤óÏñ¥ÎÇòÏßÄ ÏïäÎèÑÎ°ù Ï°∞Ï†ï
                    if (newWidth > maxWidth) {
                        newWidth = maxWidth;
                        newHeight = newWidth * (img.height / img.width);
                    }
                    if (newHeight > maxHeight) {
                        newHeight = maxHeight;
                        newWidth = newHeight * (img.width / img.height);
                    }

                    console.log('Î¶¨ÏÇ¨Ïù¥Ï¶à Ïãú ÏõêÎ≥∏ ÌÅ¨Í∏∞ Ïú†ÏßÄ:', newWidth, 'x', newHeight);

                    fabricCanvas.setWidth(newWidth);
                    fabricCanvas.setHeight(newHeight);

                    // Ïù¥ÎØ∏ÏßÄ Ïä§ÏºÄÏùº Ï°∞Ï†ï
                    const scaleX = newWidth / img.width;
                    const scaleY = newHeight / img.height;
                    img.scaleX = scaleX;
                    img.scaleY = scaleY;
                    img.left = 0;
                    img.top = 0;
                    img.setCoords?.();
                    fabricCanvas.renderAll();

                    // Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞Ïóê Îî∞Îùº Ïä§ÌÅ¨Î°§ ÌïÑÏöî Ïó¨Î∂Ä ÌôïÏù∏
                    setContainerScrollableIfNeeded(newWidth, newHeight);
                }
            }
            // windowÏóê ÎÖ∏Ï∂ú
            window.fitImageToContainer = fitImageToContainer;

            // Ï∫îÎ≤ÑÏä§ Î¶¨ÏÇ¨Ïù¥Ï¶à Í∏∞Îä•
            let isResizing = false;
            let resizeHandle = null;
            let resizeStartX, resizeStartY, resizeStartWidth, resizeStartHeight;

            function createResizeHandle() {
                if (resizeHandle) return; // Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎ©¥ ÏÉùÏÑ±ÌïòÏßÄ ÏïäÏùå

                resizeHandle = document.createElement('div');
                resizeHandle.className = 'canvas-resize-handle';
                resizeHandle.style.display = 'block'; // Ï≤òÏùåÎ∂ÄÌÑ∞ ÌëúÏãú
                document.body.appendChild(resizeHandle);

                // ÎßàÏö∞Ïä§ Îã§Ïö¥ Ïù¥Î≤§Ìä∏
                resizeHandle.addEventListener('mousedown', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    isResizing = true;
                    resizeStartX = e.clientX;
                    resizeStartY = e.clientY;
                    resizeStartWidth = fabricCanvas.width;
                    resizeStartHeight = fabricCanvas.height;

                    document.addEventListener('mousemove', handleResize);
                    document.addEventListener('mouseup', stopResize);
                });
            }

            function updateResizeHandlePosition() {
                if (!resizeHandle) return;

                const canvas = fabricCanvas.getElement();
                const rect = canvas.getBoundingClientRect();

                resizeHandle.style.left = (rect.right - 10) + 'px';
                resizeHandle.style.top = (rect.bottom - 10) + 'px';
                resizeHandle.style.display = 'block';
            }

            function handleResize(e) {
                if (!isResizing) return;

                const deltaX = e.clientX - resizeStartX;
                const deltaY = e.clientY - resizeStartY;

                // ÏµúÏÜå ÌÅ¨Í∏∞ Ï†úÌïú
                const minSize = 100;
                const newWidth = Math.max(minSize, resizeStartWidth + deltaX);
                const newHeight = Math.max(minSize, resizeStartHeight + deltaY);

                // Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
                fabricCanvas.setWidth(newWidth);
                fabricCanvas.setHeight(newHeight);

                // Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏûàÏúºÎ©¥ Ïä§ÏºÄÏùº Ï°∞Ï†ï
                const bg = fabricCanvas.backgroundImage;
                if (bg) {
                    const scaleX = newWidth / bg.width;
                    const scaleY = newHeight / bg.height;
                    bg.scaleX = scaleX;
                    bg.scaleY = scaleY;
                    bg.setCoords();
                }

                fabricCanvas.renderAll();
                updateResizeHandlePosition();
                setContainerScrollableIfNeeded(newWidth, newHeight);
            }

            function stopResize() {
                isResizing = false;
                document.removeEventListener('mousemove', handleResize);
                document.removeEventListener('mouseup', stopResize);
            }

            // Ï∫îÎ≤ÑÏä§Ïóê ÎßàÏö∞Ïä§ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
            fabricCanvas.on('mouse:over', function () {
                createResizeHandle();
                updateResizeHandlePosition();
            });

            // Ï∫îÎ≤ÑÏä§ Î°úÎìú Ïãú Ï¶âÏãú Î¶¨ÏÇ¨Ïù¥Ï¶à Ìï∏Îì§ ÏÉùÏÑ±
            createResizeHandle();
            updateResizeHandlePosition();

            fabricCanvas.on('mouse:out', function () {
                // Î¶¨ÏÇ¨Ïù¥Ï¶à Ìï∏Îì§ÏùÑ Ìï≠ÏÉÅ ÌëúÏãúÌïòÎèÑÎ°ù ÏàòÏ†ï
                if (resizeHandle && !isResizing) {
                    // Ìï∏Îì§ÏùÑ Ïà®Í∏∞ÏßÄ ÏïäÍ≥† Ïú†ÏßÄ
                    updateResizeHandlePosition();
                }
            });

            // Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ Î≥ÄÍ≤Ω Ïãú Ìï∏Îì§ ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏
            const originalSetWidth = fabricCanvas.setWidth;
            const originalSetHeight = fabricCanvas.setHeight;

            fabricCanvas.setWidth = function (width) {
                originalSetWidth.call(this, width);
                updateResizeHandlePosition();
            };

            fabricCanvas.setHeight = function (height) {
                originalSetHeight.call(this, height);
                updateResizeHandlePosition();
            };

            // Ïª®ÌÖåÏù¥ÎÑà Ïä§ÌÅ¨Î°§ ÌïÑÏöî Ïó¨Î∂Ä ÏÑ§Ï†ï
            function setContainerScrollableIfNeeded(imgWidth, imgHeight) {
                const container = document.getElementById("container");
                const containerWidth = container.clientWidth;
                const containerHeight = container.clientHeight;

                // Ïó¨Ïú† Í≥µÍ∞ÑÏùÑ ÎëêÍ≥† Ïä§ÌÅ¨Î°§ ÌïÑÏöî Ïó¨Î∂Ä ÌåêÎã® (20px Ïó¨Ïú†)
                if (
                    imgWidth > containerWidth - 20 ||
                    imgHeight > containerHeight - 20
                ) {
                    container.classList.add("scrollable");
                } else {
                    container.classList.remove("scrollable");
                }
            }
            window.addEventListener("resize", fitImageToContainer);
            fitImageToContainer();

            fabricCanvas.on("path:created", function (opt) {
                objectCounters.pan++;
                opt.path.set({
                    customLabel: "ÏûêÏú†Í≥°ÏÑ†" + objectCounters.pan,
                    selectable: true,
                    evented: true,
                });
                fabricCanvas.setActiveObject(opt.path);
                saveHistory();
                setMode("none");
            });

            function saveHistory() {
                // customLabel ÏÜçÏÑ±ÏùÑ Ìè¨Ìï®ÌïòÏó¨ Ï†ÄÏû•
                const canvasJSON = fabricCanvas.toJSON(["customLabel"]);
                // Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ Ï†ïÎ≥¥Îäî Î≥ÑÎèÑÎ°ú Ï†ÄÏû•
                const backgroundImage = fabricCanvas.backgroundImage;
                const current = JSON.stringify(canvasJSON);
                if (current !== lastSavedJSON) {
                    history.push(canvasJSON);
                    lastSavedJSON = current;
                    updateLayerList();
                }
            }
            function setMode(mode) {
                fabricCanvas.isDrawingMode = false;
                currentMode = mode;
                document
                    .querySelectorAll("#toolbar button")
                    .forEach((btn) => btn.classList.remove("active"));
                const btn = document.getElementById("btn-" + mode);
                if (btn) btn.classList.add("active");
                fabricCanvas.setCursor(mode === "pan" ? "default" : "crosshair");

                // ÎèÑÌòï Í∑∏Î¶¨Í∏∞ Î™®ÎìúÏùº ÎïåÎäî Ïò§Î∏åÏ†ùÌä∏ Î¨¥Ïãú
                if (["line", "circle", "rect", "triangle", "pan"].includes(mode)) {
                    fabricCanvas.skipTargetFind = true;
                } else {
                    fabricCanvas.skipTargetFind = false;
                }
                if (mode === "pan") {
                    fabricCanvas.isDrawingMode = true;
                    fabricCanvas.freeDrawingBrush.width = 2;
                    fabricCanvas.freeDrawingBrush.color = "#000000";
                }
            }
            // windowÏóê ÎÖ∏Ï∂ú
            window.setMode = setMode;

            fabricCanvas.on("mouse:down", function (opt) {
                const pointer = fabricCanvas.getPointer(opt.e);
                const isRightClick = opt.e.button === 2;
                const isEmptyClick = !opt.target;
                const hasSelection = !!fabricCanvas.getActiveObject();

                if (currentMode === "pan" || isRightClick) return;

                if (isEmptyClick && hasSelection) {
                    fabricCanvas.discardActiveObject();
                    fabricCanvas.renderAll();
                    return;
                }

                if (isEmptyClick) {
                    fabricCanvas.discardActiveObject();
                    fabricCanvas.renderAll();
                    isDrawing = true;
                    startX = pointer.x;
                    startY = pointer.y;

                    if (currentMode === "line") {
                        objectCounters.line++;
                        const label = "ÏßÅÏÑ†" + objectCounters.line;
                        currentShape = new fabric.Line(
                            [startX, startY, startX + 0.1, startY + 0.1],
                            {
                                stroke: "#000000",
                                strokeWidth: 2,
                                customLabel: label,
                            }
                        );
                        fabricCanvas.add(currentShape);
                    } else if (currentMode === "arrow") {
                        objectCounters.arrow++;
                        const label = "ÏπòÏàòÏÑ†" + objectCounters.arrow;
                        // ÏûÑÏãúÎ°ú ÏÑ†Îßå Î®ºÏ†Ä Í∑∏Î¶º, mouse:moveÏóêÏÑú Í∑∏Î£πÏúºÎ°ú ÎåÄÏ≤¥
                        currentShape = new fabric.Line(
                            [startX, startY, startX + 0.1, startY + 0.1],
                            {
                                stroke: "#000000",
                                strokeWidth: 2,
                                customLabel: label,
                            }
                        );
                        fabricCanvas.add(currentShape);
                    } else if (currentMode === "circle") {
                        objectCounters.circle++;
                        const label = "Ïõê" + objectCounters.circle;
                        currentShape = new fabric.Circle({
                            left: startX,
                            top: startY,
                            radius: 1,
                            originX: "left",
                            originY: "top",
                            fill: "transparent",
                            stroke: "#000000",
                            strokeWidth: 2,
                            customLabel: label,
                        });
                        fabricCanvas.add(currentShape);
                    } else if (currentMode === "rect") {
                        objectCounters.rect++;
                        const label = "ÏÇ¨Í∞ÅÌòï" + objectCounters.rect;
                        currentShape = new fabric.Rect({
                            left: startX,
                            top: startY,
                            width: 1,
                            height: 1,
                            fill: "transparent",
                            stroke: "#000000",
                            strokeWidth: 2,
                            customLabel: label,
                            // originX: "left",
                            // originY: "top",
                        });
                        fabricCanvas.add(currentShape);
                    } else if (currentMode === "triangle") {
                        objectCounters.triangle++;
                        const label = "ÏÇºÍ∞ÅÌòï" + objectCounters.triangle;
                        currentShape = new fabric.Triangle({
                            left: startX,
                            top: startY,
                            width: 1,
                            height: 1,
                            fill: "transparent",
                            stroke: "#000000",
                            strokeWidth: 2,
                            customLabel: label,
                            // originX: "left",
                            // originY: "top",
                        });
                        fabricCanvas.add(currentShape);
                    }
                }
            });

            fabricCanvas.on("mouse:move", function (opt) {
                const pointer = fabricCanvas.getPointer(opt.e);
                document.getElementById(
                    "coordDisplay"
                ).innerText = `x: ${pointer.x.toFixed(0)}, y: ${pointer.y.toFixed(
                    0
                )}`;
                if (!isDrawing || !currentShape) return;

                if (currentMode === "line") {
                    currentShape.set({ x2: pointer.x + 0.001, y2: pointer.y + 0.001 });
                } else if (currentMode === "arrow") {
                    console.log("arrow");

                    const arrowLength = 16; // ÌôîÏÇ¥Ï¥â Í∏∏Ïù¥
                    const width = 10; // ÌôîÏÇ¥Ï¥â Ìè≠
                    const pixelFix = 2; // Ïò§Î•∏Ï™Ω ÌôîÏÇ¥Ï¥âÍ≥º ÏÑ† ÏÇ¨Ïù¥ Î≥¥Ï†ï

                    const lineDx = pointer.x - currentShape.x1;
                    const lineDy = pointer.y - currentShape.y1;
                    const lineAngle = Math.atan2(lineDy, lineDx);

                    // ÎÅùÏ†ê Î≥¥Ï†ï (ÌôîÏÇ¥Ï¥â Î∞ëÎ©¥Î≥¥Îã§ ÏïàÏ™ΩÏúºÎ°ú Îì§Ïñ¥Ïò§Í≤å)
                    const adjustedX = Number(
                        (
                            pointer.x -
                            (arrowLength - pixelFix) * Math.cos(lineAngle)
                        ).toFixed(2)
                    );
                    const adjustedY = Number(
                        (
                            pointer.y -
                            (arrowLength - pixelFix) * Math.sin(lineAngle)
                        ).toFixed(2)
                    );

                    // ÏÑ† Ï¢åÌëú ÏóÖÎç∞Ïù¥Ìä∏ (ÏãúÏûëÏ†êÏùÄ ÌÅ¥Î¶≠ ÏúÑÏπò Í∑∏ÎåÄÎ°ú, ÎÅùÏ†êÎßå Î≥¥Ï†ï)
                    currentShape.set({
                        x1: currentShape.x1,
                        y1: currentShape.y1,
                        x2: adjustedX,
                        y2: adjustedY,
                    });

                    // Í∏∞Ï°¥ ÌôîÏÇ¥Ï¥â/Ï∫° Ï†úÍ±∞
                    fabricCanvas.remove(currentShape.arrowHead);
                    fabricCanvas.remove(currentShape.startArrowHead);
                    fabricCanvas.remove(currentShape.arrowCap);
                    fabricCanvas.remove(currentShape.startArrowCap);

                    // ---------- Ïò§Î•∏Ï™Ω ÌôîÏÇ¥Ï¥â ----------
                    // tip(Îæ∞Ï°±Ìïú ÎÅù)ÏùÄ ÎßàÏö∞Ïä§ ÏúÑÏπò
                    const tipX = pointer.x;
                    const tipY = pointer.y;
                    // base(Î∞ëÎ≥Ä Ï§ëÏã¨)ÏùÄ tipÏóêÏÑú arrowLengthÎßåÌÅº ÏÑ†Ïùò Î∞òÎåÄÎ∞©Ìñ•ÏúºÎ°ú Ïù¥Îèô
                    const baseX = tipX - arrowLength * Math.cos(lineAngle);
                    const baseY = tipY - arrowLength * Math.sin(lineAngle);
                    // perpAngle(ÏàòÏßÅÎ∞©Ìñ•)Î°ú width/2ÎßåÌÅº Ïù¥ÎèôÌï¥ÏÑú Î∞ëÎ≥Ä ÏñëÎÅù Í≥ÑÏÇ∞
                    const perpAngle = lineAngle + Math.PI / 2;
                    const leftX = baseX + (width / 2) * Math.cos(perpAngle);
                    const leftY = baseY + (width / 2) * Math.sin(perpAngle);
                    const rightX = baseX - (width / 2) * Math.cos(perpAngle);
                    const rightY = baseY - (width / 2) * Math.sin(perpAngle);
                    const arrowHead = new fabric.Polygon(
                        [
                            { x: tipX, y: tipY },
                            { x: leftX, y: leftY },
                            { x: rightX, y: rightY },
                        ],
                        {
                            fill: currentShape.stroke || "#000000",
                            selectable: false,
                            evented: false,
                            hasControls: false,
                            hasBorders: false,
                            objectCaching: false,
                            hoverCursor: "default",
                        }
                    );
                    fabricCanvas.add(arrowHead);
                    currentShape.arrowHead = arrowHead;

                    // Ïò§Î•∏Ï™Ω | Ï∫° Ï∂îÍ∞Ä (Îæ∞Ï°±Ìïú ÎÅùÏóê, Î∞ëÎ≥ÄÏùò 1/2)
                    const baseLength = Math.sqrt(
                        Math.pow(leftX - rightX, 2) + Math.pow(leftY - rightY, 2)
                    );
                    const capLength = baseLength * 2;
                    const perpUnitX = Math.cos(perpAngle);
                    const perpUnitY = Math.sin(perpAngle);
                    const capX1 = tipX + (capLength / 2) * perpUnitX;
                    const capY1 = tipY + (capLength / 2) * perpUnitY;
                    const capX2 = tipX - (capLength / 2) * perpUnitX;
                    const capY2 = tipY - (capLength / 2) * perpUnitY;
                    const capLine = new fabric.Line([capX1, capY1, capX2, capY2], {
                        stroke: currentShape.stroke || "#000000",
                        strokeWidth: currentShape.strokeWidth || 2,
                        selectable: false,
                        evented: false,
                        hasControls: false,
                        hasBorders: false,
                        objectCaching: false,
                        hoverCursor: "default",
                        isArrowCap: true, // Ï∫° ÏãùÎ≥ÑÏö© ÏÜçÏÑ± Ï∂îÍ∞Ä
                    });
                    fabricCanvas.add(capLine);
                    currentShape.arrowCap = capLine;

                    // ---------- ÏôºÏ™Ω ÌôîÏÇ¥Ï¥â ----------
                    // tip(Îæ∞Ï°±Ìïú ÎÅù)ÏùÄ ÏãúÏûëÏ†êÏóêÏÑú arrowLengthÎßåÌÅº ÏÑ†Ïùò Î∞òÎåÄÎ∞©Ìñ•ÏúºÎ°ú Ïù¥Îèô
                    const startBaseX = currentShape.x1 + 3;
                    const startBaseY = currentShape.y1;
                    const startTipX =
                        startBaseX + arrowLength * Math.cos(lineAngle + Math.PI);
                    const startTipY =
                        startBaseY + arrowLength * Math.sin(lineAngle + Math.PI);
                    // base(Î∞ëÎ≥Ä Ï§ëÏã¨)ÏùÄ ÏãúÏûëÏ†ê
                    const startPerpAngle = lineAngle + Math.PI / 2;
                    const startLeftX =
                        startBaseX + (width / 2) * Math.cos(startPerpAngle);
                    const startLeftY =
                        startBaseY + (width / 2) * Math.sin(startPerpAngle);
                    const startRightX =
                        startBaseX - (width / 2) * Math.cos(startPerpAngle);
                    const startRightY =
                        startBaseY - (width / 2) * Math.sin(startPerpAngle);
                    const startArrowHead = new fabric.Polygon(
                        [
                            { x: startTipX, y: startTipY },
                            { x: startLeftX, y: startLeftY },
                            { x: startRightX, y: startRightY },
                        ],
                        {
                            fill: currentShape.stroke || "#000000",
                            selectable: false,
                            evented: false,
                            hasControls: false,
                            hasBorders: false,
                            objectCaching: false,
                            hoverCursor: "default",
                        }
                    );
                    fabricCanvas.add(startArrowHead);
                    currentShape.startArrowHead = startArrowHead;

                    // ÏôºÏ™Ω | Ï∫° Ï∂îÍ∞Ä (Îæ∞Ï°±Ìïú ÎÅùÏóê, Î∞ëÎ≥ÄÏùò 1/2)
                    const startBaseLength = Math.sqrt(
                        Math.pow(startLeftX - startRightX, 2) +
                        Math.pow(startLeftY - startRightY, 2)
                    );
                    const startCapLength = startBaseLength * 2;
                    const startPerpUnitX = Math.cos(startPerpAngle);
                    const startPerpUnitY = Math.sin(startPerpAngle);
                    const startCapX1 =
                        startTipX + (startCapLength / 2) * startPerpUnitX;
                    const startCapY1 =
                        startTipY + (startCapLength / 2) * startPerpUnitY;
                    const startCapX2 =
                        startTipX - (startCapLength / 2) * startPerpUnitX;
                    const startCapY2 =
                        startTipY - (startCapLength / 2) * startPerpUnitY;
                    const startCapLine = new fabric.Line(
                        [startCapX1, startCapY1, startCapX2, startCapY2],
                        {
                            stroke: currentShape.stroke || "#000000",
                            strokeWidth: currentShape.strokeWidth || 2,
                            selectable: false,
                            evented: false,
                            hasControls: false,
                            hasBorders: false,
                            objectCaching: false,
                            hoverCursor: "default",
                            isArrowCap: true, // Ï∫° ÏãùÎ≥ÑÏö© ÏÜçÏÑ± Ï∂îÍ∞Ä
                        }
                    );
                    fabricCanvas.add(startCapLine);
                    currentShape.startArrowCap = startCapLine;
                    fabricCanvas.renderAll();
                } else if (currentMode === "circle") {
                    const width = Math.abs(pointer.x - startX);
                    const height = Math.abs(pointer.y - startY);
                    const diameter = Math.min(width, height);
                    currentShape.set({
                        left: Math.min(pointer.x, startX),
                        top: Math.min(pointer.y, startY),
                        radius: diameter / 2,
                    });
                } else if (currentMode === "rect") {
                    const width = pointer.x - startX;
                    const height = pointer.y - startY;
                    currentShape.set({
                        left: width < 0 ? pointer.x : startX,
                        top: height < 0 ? pointer.y : startY,
                        width: Math.abs(width),
                        height: Math.abs(height),
                    });
                } else if (currentMode === "triangle") {
                    const width = pointer.x - startX;
                    const height = pointer.y - startY;
                    currentShape.set({
                        left: width < 0 ? pointer.x : startX,
                        top: height < 0 ? pointer.y : startY,
                        width: Math.abs(width),
                        height: Math.abs(height),
                    });
                }
                fabricCanvas.renderAll();
            });

            fabricCanvas.on("mouse:up", function () {
                if (isDrawing && currentShape) {
                    if (currentMode === "arrow" && currentShape.arrowHead) {
                        // ÏÑ†+ÌôîÏÇ¥Ï¥â+Ï∫° Í∑∏Î£πÌôî (ÏñëÏ™Ω)
                        const groupObjs = [currentShape];
                        if (currentShape.arrowHead)
                            groupObjs.push(currentShape.arrowHead);
                        if (currentShape.startArrowHead)
                            groupObjs.push(currentShape.startArrowHead);
                        if (currentShape.arrowCap) groupObjs.push(currentShape.arrowCap);
                        if (currentShape.startArrowCap)
                            groupObjs.push(currentShape.startArrowCap);

                        // ÏπòÏàòÏÑ† Ï§ëÏïôÏóê ÌÖçÏä§Ìä∏ Ï∂îÍ∞Ä
                        objectCounters.textbox++;
                        const centerX = (currentShape.x1 + currentShape.x2) / 2;
                        const centerY = (currentShape.y1 + currentShape.y2) / 2;
                        const textOffset = 40; // ÌÖçÏä§Ìä∏Î•º ÏúÑÎ°ú Ïò¨Î¶¥ ÌîΩÏÖÄ Ïàò

                        const arrowText = new fabric.Textbox("ÌÖçÏä§Ìä∏ ÏûÖÎ†•", {
                            left: centerX,
                            top: centerY - textOffset,
                            fill: currentShape.stroke || "#000000",
                            backgroundColor: "transparent",
                            fontFamily: "Arial",
                            originX: "center",
                            originY: "center",
                            selectable: true,
                            evented: true,
                            hasControls: true,
                            hasBorders: true,
                            objectCaching: false,
                            hoverCursor: "move",
                            fontSize: 20,
                            width: 100,
                            textAlign: "center",
                            customLabel: "ÌÖçÏä§Ìä∏" + objectCounters.textbox,
                        });

                        const group = new fabric.Group(groupObjs, {
                            customLabel: currentShape.customLabel,
                        });
                        if (currentShape.arrowHead)
                            fabricCanvas.remove(currentShape.arrowHead);
                        if (currentShape.startArrowHead)
                            fabricCanvas.remove(currentShape.startArrowHead);
                        if (currentShape.arrowCap)
                            fabricCanvas.remove(currentShape.arrowCap);
                        if (currentShape.startArrowCap)
                            fabricCanvas.remove(currentShape.startArrowCap);
                        fabricCanvas.remove(currentShape);
                        fabricCanvas.add(group);
                        fabricCanvas.setActiveObject(group);
                        saveHistory();
                        setMode("none");
                        shapeProperties.style.display = "none";
                        // ÌÖçÏä§Ìä∏ Î∞ïÏä§Î•º Í∑∏Î£πÏóê Ìè¨Ìï®ÌïòÏßÄ ÏïäÍ≥† Î≥ÑÎèÑÎ°ú Ï∂îÍ∞Ä
                        fabricCanvas.add(arrowText);
                        fabricCanvas.bringToFront(arrowText);

                        fabricCanvas.renderAll();
                        isDrawing = false;
                        currentShape = null;
                        return;
                    }
                    saveHistory();
                    setMode("none");
                    fabricCanvas.setActiveObject(currentShape);
                    shapeProperties.style.display = "none";
                    fabricCanvas.renderAll();
                }
                isDrawing = false;
                currentShape = null;
            });

            function addText() {
                objectCounters.textbox++;
                const textbox = new fabric.Textbox("ÌÖçÏä§Ìä∏ ÏûÖÎ†•", {
                    left: 100,
                    top: 100,
                    fontSize: 20,
                    fill: "#000000",
                    backgroundColor: "transparent",
                    hoverCursor: "move",
                    customLabel: "ÌÖçÏä§Ìä∏" + objectCounters.textbox,
                });
                fabricCanvas.add(textbox);
                fabricCanvas.setActiveObject(textbox);
                // Ìï≠ÏÉÅ Îß® ÏúÑÎ°ú Ïò¨Î¶¨Í∏∞
                fabricCanvas.bringToFront(textbox);
                saveHistory();
            }
            // windowÏóê ÎÖ∏Ï∂ú
            window.addText = addText;

            function undo() {
                if (history.length > 1) {
                    history.pop();
                    const previousState = history[history.length - 1];

                    // Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ ÏûÑÏãú Ï†ÄÏû•
                    const currentBg = fabricCanvas.backgroundImage;

                    fabricCanvas.loadFromJSON(previousState, () => {
                        // Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ Î≥µÏõê
                        if (currentBg) {
                            fabricCanvas.setBackgroundImage(currentBg, () => {
                                fabricCanvas.renderAll();
                            });
                        } else {
                            fabricCanvas.renderAll();
                        }

                        lastSavedJSON = JSON.stringify(fabricCanvas.toJSON(["customLabel"]));
                        updateLayerList();
                    });
                }
            }
            /*function undo() {
              if (history.length > 1) {
                history.pop();
                fabricCanvas.loadFromJSON(history[history.length - 1], () => {
                  fabricCanvas.renderAll();
                  // customLabel ÏÜçÏÑ±ÏùÑ Ìè¨Ìï®ÌïòÏó¨ lastSavedJSON ÏóÖÎç∞Ïù¥Ìä∏
                  lastSavedJSON = JSON.stringify(
                    fabricCanvas.toJSON(["customLabel"])
                  );
                  updateLayerList();
                });
              }
            }*/

            // windowÏóê ÎÖ∏Ï∂ú
            window.undo = undo;

            // function saveImage() {
            //   // ÏõêÎ≥∏ ÌÅ¨Í∏∞ ÏßÄÏ†ï (Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏûàÏúºÎ©¥ Í∑∏ ÌÅ¨Í∏∞, ÏóÜÏúºÎ©¥ Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞)
            //   const now = new Date();
            //   const timestamp = now.toISOString().replace(/[:T]/g, '-').split('.')[0];
            //
            //   // let exportWidth = fabricCanvas.backgroundImage
            //   //   ? fabricCanvas.backgroundImage.width
            //   //   : fabricCanvas.width;
            //   // let exportHeight = fabricCanvas.backgroundImage
            //   //   ? fabricCanvas.backgroundImage.height
            //   //   : fabricCanvas.height;
            //   let exportWidth = fabricImgWidth;
            //   let exportHeight = fabricImgHeight;
            //   const dataURL = fabricCanvas.toDataURL({
            //     format: "png",
            //     width: exportWidth,
            //     height: exportHeight,
            //     left: 0,
            //     top: 0,
            //   });
            //   const link = document.createElement("a");
            //   link.href = dataURL;
            //   link.download = "ÏßÄÎèÑÏ∫°Ï≥ê-" + timestamp + ".png";
            //   link.click();
            // }
            function saveImage() {
                const now = new Date();
                const timestamp = now.toISOString().replace(/[:T]/g, '-').split('.')[0];

                console.log('=== Ï†ÄÏû• ÏãúÏûë ===');
                console.log('fabricImgWidth:', fabricImgWidth);
                console.log('fabricImgHeight:', fabricImgHeight);
                console.log('Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞:', fabricCanvas.width, 'x', fabricCanvas.height);

                if (fabricCanvas.backgroundImage) {
                    const bg = fabricCanvas.backgroundImage;
                    console.log('Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ:', {
                        ÏõêÎ≥∏: `${bg.width} x ${bg.height}`,
                        ÏúÑÏπò: `${bg.left}, ${bg.top}`,
                        Ïä§ÏºÄÏùº: `${bg.scaleX} x ${bg.scaleY}`,
                        ÌëúÏãúÌÅ¨Í∏∞: `${bg.getScaledWidth()} x ${bg.getScaledHeight()}`
                    });
                }

                // ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞Î°ú Ï†ÄÏû• (Ìé∏Ïßë Ìé∏ÏùòÎ•º ÏúÑÌï¥ ÌôïÎåÄÎêú Í≤ΩÏö∞ÏóêÎèÑ ÏõêÎ≥∏ ÌÅ¨Í∏∞Î°ú Ï†ÄÏû•)
                let exportWidth = fabricImgWidth || fabricCanvas.width;
                let exportHeight = fabricImgHeight || fabricCanvas.height;

                console.log(`ÏõêÎ≥∏ ÌÅ¨Í∏∞Î°ú Ï†ÄÏû•: ${exportWidth} x ${exportHeight}`);
                console.log(`ÌòÑÏû¨ Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞: ${fabricCanvas.width} x ${fabricCanvas.height}`);

                // ÏõêÎ≥∏ ÌÅ¨Í∏∞Î°ú ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (ÌôîÏßà Ïú†ÏßÄ)
                const dataURL = fabricCanvas.toDataURL({
                    format: "png",
                    width: exportWidth,
                    height: exportHeight,
                    quality: 1.0
                });

                // Base64 Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞ ÌôïÏù∏ (Ïù¥Ï†ÑÏóê ÎßåÎì† Ìï®Ïàò ÏÇ¨Ïö©)
                const img = new Image();
                img.onload = function () {
                    console.log(`Ïã§Ï†ú ÎÇ¥Î≥¥ÎÇ∏ ÌÅ¨Í∏∞: ${this.naturalWidth} x ${this.naturalHeight}`);
                };
                img.src = dataURL;

                const link = document.createElement("a");
                link.href = dataURL;
                link.download = "ÏßÄÎèÑÏ∫°Ï≥ê-" + timestamp + ".png";
                link.click();

                console.log('=== Ï†ÄÏû• ÏôÑÎ£å ===');
            }
            // windowÏóê ÎÖ∏Ï∂ú
            window.saveImage = saveImage;

            function selectLayer(index) {
                const obj = fabricCanvas.item(index);
                fabricCanvas.setActiveObject(obj);
                fabricCanvas.renderAll();
                updateLayerList();
            }
            // windowÏóê ÎÖ∏Ï∂ú
            window.selectLayer = selectLayer;

            function getLayerIcon(obj) {
                if (obj.type === "textbox") return "üìù";
                if (obj.type === "line") return "‚ûñ";
                if (obj.type === "circle") return "‚ö™";
                if (obj.type === "rect") return "‚¨õ";
                if (obj.type === "triangle") return "üî∫";
                if (obj.type === "path") return "‚úèÔ∏è";
                if (
                    obj.type === "group" &&
                    obj.customLabel &&
                    obj.customLabel.startsWith("ÏπòÏàòÏÑ†")
                )
                    return "‚ÜîÔ∏è";
                return "‚ùì";
            }

            function updateLayerList() {
                const list = document.getElementById("layerList");
                if (list) {
                    list.innerHTML = "<strong>Î†àÏù¥Ïñ¥ Î™©Î°ù</strong>";
                    const activeObjects = fabricCanvas.getActiveObjects();

                    fabricCanvas.getObjects().forEach((obj, index) => {
                        const label = obj.customLabel || "‚ùì Ïù¥Î¶ÑÏóÜÏùå";
                        const isDashed = obj.strokeDashArray ? " (Ï†êÏÑ†)" : "";

                        const item = document.createElement("div");
                        item.className = "layer-item";
                        if (activeObjects.includes(obj)) item.classList.add("selected");

                        const title = document.createElement("div");
                        title.className = "layer-label";
                        const icon = getLayerIcon(obj);
                        title.innerText = `${icon} ${label}${isDashed}`;

                        const btnGroup = document.createElement("div");
                        btnGroup.className = "layer-buttons";

                        const selectBtn = document.createElement("button");
                        selectBtn.innerText = "ÏÑ†ÌÉù";
                        selectBtn.onclick = (e) => {
                            e.stopPropagation();
                            selectLayer(index);
                        };

                        const deleteBtn = document.createElement("button");
                        deleteBtn.innerText = "ÏÇ≠Ï†ú";
                        deleteBtn.onclick = (e) => {
                            e.stopPropagation();
                            deleteLayer(index);
                        };

                        btnGroup.appendChild(selectBtn);
                        btnGroup.appendChild(deleteBtn);
                        item.appendChild(title);
                        item.appendChild(btnGroup);

                        item.addEventListener("click", () => selectLayer(index));
                        list.appendChild(item);
                    });
                }
            }
            // windowÏóê ÎÖ∏Ï∂ú
            window.updateLayerList = updateLayerList;

            function deleteLayer(index) {
                const obj = fabricCanvas.item(index);
                fabricCanvas.remove(obj);
                fabricCanvas.discardActiveObject();
                fabricCanvas.renderAll();
                saveHistory();
            }
            // windowÏóê ÎÖ∏Ï∂ú
            window.deleteLayer = deleteLayer;

            // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
            document.addEventListener("keydown", fabricHandleKeyDown);

            // popup_close ÏöîÏÜåÍ∞Ä Ï°¥Ïû¨Ìï† ÎïåÎßå Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
            const popupClose = document.getElementById('popup_close');
            if (popupClose) {
                popupClose.addEventListener('click', function () {
                    document.removeEventListener("keydown", fabricHandleKeyDown);
                });
            }

            fabricCanvas.upperCanvasEl.addEventListener(
                "wheel",
                function (e) {
                    // ÌôïÎåÄ/Ï∂ïÏÜå Í∏∞Îä• Ï†úÍ±∞
                },
                { passive: false }
            );

            fabricCanvas.upperCanvasEl.addEventListener("contextmenu", (e) => {
                e.preventDefault();
                console.log('Ïö∞ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Î∞úÏÉù');

                // ÎßàÏö∞Ïä§ ÏúÑÏπò Ï†ÄÏû•
                window.lastMouseX = e.clientX;
                window.lastMouseY = e.clientY;

                // Ïö∞ÌÅ¥Î¶≠Ìïú ÏúÑÏπòÏóêÏÑú Í∞ùÏ≤¥ Ï∞æÍ∏∞
                const pointer = fabricCanvas.getPointer(e);
                const clickedObject = fabricCanvas.findTarget(e);
                console.log('ÌÅ¥Î¶≠Îêú Í∞ùÏ≤¥:', clickedObject);

                if (clickedObject) {
                    // Ìï¥Îãπ Í∞ùÏ≤¥Î•º ÌôúÏÑ±ÌôîÌïòÍ≥† ÏÜçÏÑ±Ìé∏Ïßë ÌåùÏóÖ ÌëúÏãú
                    fabricCanvas.setActiveObject(clickedObject);
                    fabricCanvas.renderAll();
                    updateLayerList();
                    showShapeProperties();
                    console.log('ÏÜçÏÑ±Ìé∏Ïßë ÌåùÏóÖ ÌëúÏãú');
                } else {
                    console.log('Í∞ùÏ≤¥Í∞Ä ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏùå');
                }
            });

            // Ï†ÑÏó≠ Î≥ÄÏàòÎ°ú Ïù¥Îèô
            const shapeProperties = document.getElementById("shapeProperties");
            const strokeColorInput = document.getElementById("strokeColor");
            const strokeWidthInput = document.getElementById("strokeWidth");
            const fillColorInput = document.getElementById("fillColor");
            const fillSection = document.getElementById("fillSection");
            const dashedSection = document.getElementById("dashedSection");
            const dashedToggle = document.getElementById("dashedToggle");
            const transparentBtn = document.getElementById("transparentBtn");
            const textBackgroundSection = document.getElementById(
                "textBackgroundSection"
            );
            const textBackgroundColorInput = document.getElementById(
                "textBackgroundColor"
            );
            const textBackgroundTransparentBtn = document.getElementById(
                "textBackgroundTransparentBtn"
            );

            // ÎìúÎûòÍ∑∏ Í∏∞Îä• Ï¥àÍ∏∞Ìôî
            function initDrag() {
                const header = shapeProperties.querySelector(".header");

                header.addEventListener("mousedown", startDrag);
                document.addEventListener("mousemove", drag);
                document.addEventListener("mouseup", stopDrag);
            }

            function startDrag(e) {
                if (e.target.classList.contains("close-btn")) return;

                isDragging = true;
                dragStartX = e.clientX;
                dragStartY = e.clientY;

                // ÌòÑÏû¨ ÌåùÏóÖÏùò ÏúÑÏπòÎ•º Í∏∞Ï§ÄÏ†êÏúºÎ°ú ÏÑ§Ï†ï
                const currentLeft = parseInt(shapeProperties.style.left) || 0;
                const currentTop = parseInt(shapeProperties.style.top) || 0;
                originalLeft = currentLeft;
                originalTop = currentTop;

                e.preventDefault();
            }

            function drag(e) {
                if (!isDragging) return;

                const deltaX = e.clientX - dragStartX;
                const deltaY = e.clientY - dragStartY;

                const newLeft = originalLeft + deltaX;
                const newTop = originalTop + deltaY;

                // ÌôîÎ©¥ Í≤ΩÍ≥Ñ Ï≤¥ÌÅ¨
                const maxLeft = window.innerWidth - shapeProperties.offsetWidth;
                const maxTop = window.innerHeight - shapeProperties.offsetHeight;

                shapeProperties.style.left =
                    Math.max(0, Math.min(newLeft, maxLeft)) + "px";
                shapeProperties.style.top =
                    Math.max(0, Math.min(newTop, maxTop)) + "px";
            }

            function stopDrag() {
                isDragging = false;
            }

            // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÎìúÎûòÍ∑∏ Í∏∞Îä• Ï¥àÍ∏∞Ìôî
            initDrag();

            function setLabelText(inputId, text) {
                const input = document.querySelector(inputId);
                if (input && input.previousElementSibling) {
                    input.previousElementSibling.textContent = text;
                }
            }

            function updateShapePropertiesPanel() {
                const strokeColorInput = document.getElementById("strokeColor");
                const strokeWidthInput = document.getElementById("strokeWidth");
                const fillColorInput = document.getElementById("fillColor");

                const activeObjects = fabricCanvas.getActiveObjects();
                if (activeObjects.length === 0) {
                    return;
                }

                // Îã®Ïùº Ïò§Î∏åÏ†ùÌä∏ ÏÑ†ÌÉùÏù∏ Í≤ΩÏö∞
                if (activeObjects.length === 1) {
                    const obj = activeObjects[0];
                    if (strokeColorInput) strokeColorInput.value = obj.stroke || "#FF0000";
                    if (strokeWidthInput) strokeWidthInput.value = obj.strokeWidth || 1;
                    if (fillColorInput) fillColorInput.value =
                        obj.fill && obj.fill !== "transparent" ? obj.fill : "#ffffff";
                } else {
                    // Ïó¨Îü¨ Ïò§Î∏åÏ†ùÌä∏ ÏÑ†ÌÉùÏù∏ Í≤ΩÏö∞ - Í≥µÌÜµ ÏÜçÏÑ± ÌëúÏãú
                    const firstObj = activeObjects[0];
                    const hasCommonStroke = activeObjects.every(
                        (obj) => obj.stroke === firstObj.stroke
                    );
                    const hasCommonStrokeWidth = activeObjects.every(
                        (obj) => obj.strokeWidth === firstObj.strokeWidth
                    );
                    const hasCommonFill = activeObjects.every(
                        (obj) => obj.fill === firstObj.fill
                    );

                    // Í≥µÌÜµ ÏÜçÏÑ±Ïù¥ ÏûàÏúºÎ©¥ ÌëúÏãú, ÏóÜÏúºÎ©¥ Í∏∞Î≥∏Í∞í
                    strokeColorInput.value = hasCommonStroke
                        ? firstObj.stroke || "#FF0000"
                        : "#FF0000";
                    strokeWidthInput.value = hasCommonStrokeWidth
                        ? firstObj.strokeWidth || 1
                        : 1;
                    fillColorInput.value = hasCommonFill
                        ? firstObj.fill && firstObj.fill !== "transparent"
                            ? firstObj.fill
                            : "#ffffff"
                        : "#ffffff";
                }

                // UI ÏÑ§Ï†ï (Îã®Ïùº Ïò§Î∏åÏ†ùÌä∏ ÏÑ†ÌÉùÏù∏ Í≤ΩÏö∞ÏóêÎßå ÌÉÄÏûÖÎ≥Ñ ÏÑ§Ï†ï)
                if (activeObjects.length === 1) {
                    const obj = activeObjects[0];

                    if (obj.type === "line") {
                        fillSection.style.display = "none";
                        dashedSection.style.display = "block";
                        setLabelText("#strokeWidth", "ÏÑ† ÎëêÍªò:");
                        const strokeColorLabel = document.getElementById("strokeColorLabel");
                        if (strokeColorLabel) strokeColorLabel.textContent = "ÏÑ† ÏÉâÏÉÅ";
                        strokeColorSection.setAttribute("data-label", "ÏÑ† ÏÉâÏÉÅ ÏÑ§Ï†ï");
                        strokeWidthSection.setAttribute("data-label", "ÏÑ† ÎëêÍªò ÏÑ§Ï†ï");
                        fillSection.setAttribute("data-label", "Ï±ÑÏö∞Í∏∞ ÏÑ§Ï†ï");
                        dashedSection.setAttribute("data-label", "ÏÑ† Ïä§ÌÉÄÏùº ÏÑ§Ï†ï");
                        textBackgroundSection.style.display = "none";
                    } else if (
                        obj.type === "circle" ||
                        obj.type === "rect" ||
                        obj.type === "triangle"
                    ) {
                        fillSection.style.display = "block";
                        dashedSection.style.display = "block";
                        setLabelText("#strokeWidth", "ÏÑ† ÎëêÍªò:");
                        const strokeColorLabel = document.getElementById("strokeColorLabel");
                        if (strokeColorLabel) strokeColorLabel.textContent = "ÏÑ† ÏÉâÏÉÅ";
                        strokeColorSection.setAttribute("data-label", "ÏÑ† ÏÉâÏÉÅ ÏÑ§Ï†ï");
                        strokeWidthSection.setAttribute("data-label", "ÏÑ† ÎëêÍªò ÏÑ§Ï†ï");
                        fillSection.setAttribute("data-label", "Ï±ÑÏö∞Í∏∞ ÏÑ§Ï†ï");
                        dashedSection.setAttribute("data-label", "ÏÑ† Ïä§ÌÉÄÏùº ÏÑ§Ï†ï");
                        textBackgroundSection.style.display = "none";
                    } else if (obj.type === "textbox") {
                        fillSection.style.display = "none";
                        dashedSection.style.display = "none";
                        textBackgroundSection.style.display = "block";
                        strokeColorInput.value = obj.fill || "#FF0000";
                        strokeWidthInput.value = obj.fontSize || 20;
                        textBackgroundColorInput.value =
                            obj.backgroundColor && obj.backgroundColor !== "transparent"
                                ? obj.backgroundColor
                                : "#FFFFFF";
                        setLabelText("#strokeWidth", "Í∏ÄÏûê ÌÅ¨Í∏∞:");
                        const strokeColorLabel = document.getElementById("strokeColorLabel");
                        if (strokeColorLabel) strokeColorLabel.textContent = "Í∏ÄÏûê ÏÉâÏÉÅ";
                        strokeColorSection.setAttribute("data-label", "Í∏ÄÏûê ÏÉâÏÉÅ ÏÑ§Ï†ï");
                        strokeWidthSection.setAttribute("data-label", "Í∏ÄÏûê ÌÅ¨Í∏∞ ÏÑ§Ï†ï");
                        textBackgroundSection.setAttribute(
                            "data-label",
                            "ÌÖçÏä§Ìä∏ Î∞∞Í≤Ω ÏÑ§Ï†ï"
                        );
                        fillSection.setAttribute("data-label", "Ï±ÑÏö∞Í∏∞ ÏÑ§Ï†ï");
                        dashedSection.setAttribute("data-label", "Ïä§ÌÉÄÏùº ÏÑ§Ï†ï");
                    } else if (
                        obj.type === "group" &&
                        obj.customLabel &&
                        obj.customLabel.startsWith("ÏπòÏàòÏÑ†")
                    ) {
                        // ÏπòÏàòÏÑ† Í∑∏Î£π Ï≤òÎ¶¨ - Ï≤´ Î≤àÏß∏ ÏÑ† Í∞ùÏ≤¥Ïùò ÏÜçÏÑ±ÏùÑ ÏÇ¨Ïö©
                        const lineObj = obj
                            .getObjects()
                            .find((item) => item.type === "line");
                        if (lineObj) {
                            strokeColorInput.value = lineObj.stroke || "#FF0000";
                            strokeWidthInput.value = lineObj.strokeWidth || 1;
                        }
                        fillSection.style.display = "none";
                        dashedSection.style.display = "block";
                        setLabelText("#strokeWidth", "ÏÑ† ÎëêÍªò:");
                        const strokeColorLabel = document.getElementById("strokeColorLabel");
                        if (strokeColorLabel) strokeColorLabel.textContent = "ÏÑ† ÏÉâÏÉÅ";
                        strokeColorSection.setAttribute("data-label", "ÏÑ† ÏÉâÏÉÅ ÏÑ§Ï†ï");
                        strokeWidthSection.setAttribute("data-label", "ÏÑ† ÎëêÍªò ÏÑ§Ï†ï");
                        fillSection.setAttribute("data-label", "Ï±ÑÏö∞Í∏∞ ÏÑ§Ï†ï");
                        dashedSection.setAttribute("data-label", "ÏÑ† Ïä§ÌÉÄÏùº ÏÑ§Ï†ï");
                        textBackgroundSection.style.display = "none";
                    } else {
                        fillSection.style.display = "block";
                        dashedSection.style.display = "none";
                        textBackgroundSection.style.display = "none";
                        setLabelText("#strokeWidth", "ÏÑ† ÎëêÍªò:");
                        const strokeColorLabel = document.getElementById("strokeColorLabel");
                        if (strokeColorLabel) strokeColorLabel.textContent = "ÏÑ† ÏÉâÏÉÅ";
                        strokeColorSection.setAttribute("data-label", "ÏÑ† ÏÉâÏÉÅ ÏÑ§Ï†ï");
                        strokeWidthSection.setAttribute("data-label", "ÏÑ† ÎëêÍªò ÏÑ§Ï†ï");
                        textBackgroundSection.setAttribute(
                            "data-label",
                            "ÌÖçÏä§Ìä∏ Î∞∞Í≤Ω ÏÑ§Ï†ï"
                        );
                        fillSection.setAttribute("data-label", "Ï±ÑÏö∞Í∏∞ ÏÑ§Ï†ï");
                        dashedSection.setAttribute("data-label", "Ïä§ÌÉÄÏùº ÏÑ§Ï†ï");
                        textBackgroundSection.style.display = "none";
                    }
                } else {
                    // Ïó¨Îü¨ Ïò§Î∏åÏ†ùÌä∏ ÏÑ†ÌÉùÏù∏ Í≤ΩÏö∞ - Í≥µÌÜµ UI ÏÑ§Ï†ï
                    fillSection.style.display = "block";
                    dashedSection.style.display = "block";
                    textBackgroundSection.style.display = "none";
                    setLabelText("#strokeWidth", "ÏÑ† ÎëêÍªò:");
                    const strokeColorLabel = document.getElementById("strokeColorLabel");
                    if (strokeColorLabel) strokeColorLabel.textContent = "ÏÑ† ÏÉâÏÉÅ";
                    strokeColorSection.setAttribute("data-label", "ÏÑ† ÏÉâÏÉÅ ÏÑ§Ï†ï");
                    strokeWidthSection.setAttribute("data-label", "ÏÑ† ÎëêÍªò ÏÑ§Ï†ï");
                    textBackgroundSection.setAttribute(
                        "data-label",
                        "ÌÖçÏä§Ìä∏ Î∞∞Í≤Ω ÏÑ§Ï†ï"
                    );
                    fillSection.setAttribute("data-label", "Ï±ÑÏö∞Í∏∞ ÏÑ§Ï†ï");
                    dashedSection.setAttribute("data-label", "ÏÑ† Ïä§ÌÉÄÏùº ÏÑ§Ï†ï");
                    textBackgroundSection.style.display = "none";
                }

                // Ï†êÏÑ† ÌÜ†Í∏Ä Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                if (activeObjects.length === 1) {
                    const obj = activeObjects[0];
                    if (obj.strokeDashArray) {
                        dashedToggle.textContent = "Ï†êÏÑ†";
                        dashedToggle.classList.add("active");
                    } else {
                        dashedToggle.textContent = "Ïã§ÏÑ†";
                        dashedToggle.classList.remove("active");
                    }
                } else {
                    // Ïó¨Îü¨ Ïò§Î∏åÏ†ùÌä∏ ÏÑ†ÌÉùÏù∏ Í≤ΩÏö∞ - Í≥µÌÜµ ÏÉÅÌÉú ÌôïÏù∏
                    const hasCommonDashArray = activeObjects.every(
                        (obj) => obj.strokeDashArray === activeObjects[0].strokeDashArray
                    );

                    if (hasCommonDashArray && activeObjects[0].strokeDashArray) {
                        dashedToggle.textContent = "Ï†êÏÑ†";
                        dashedToggle.classList.add("active");
                    } else {
                        dashedToggle.textContent = "Ïã§ÏÑ†";
                        dashedToggle.classList.remove("active");
                    }
                }

                // ÌåùÏóÖ Ï†úÎ™© ÏóÖÎç∞Ïù¥Ìä∏
                const titleElement = shapeProperties.querySelector(".header strong");
                if (activeObjects.length === 1) {
                    titleElement.textContent = "ÏÜçÏÑ± Ìé∏Ïßë";
                } else {
                    titleElement.textContent = `ÏÜçÏÑ± Ìé∏Ïßë (${activeObjects.length}Í∞ú ÏÑ†ÌÉù)`;
                }

                // Ìà¨Î™Ö Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                /* if (obj.fill === "transparent" || !obj.fill) {
                transparentBtn.classList.add("active");
              } else {
                transparentBtn.classList.remove("active");
              } */
            }

            function showShapeProperties() {
                const shapeProperties = document.getElementById("shapeProperties");
                if (!shapeProperties) {
                    console.error('shapeProperties ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                    return;
                }

                updateShapePropertiesPanel();
                // 1. Î®ºÏ†Ä Ïà®ÍπÄ
                shapeProperties.style.display = "none";
                // 2. ÏúÑÏπò Í≥ÑÏÇ∞ (ÎèÑÌòï ÏúÑÏπò Í∏∞Ï§Ä)
                const obj = fabricCanvas.getActiveObject();
                if (obj) {
                    // ÎèÑÌòïÏùò Ï∫îÎ≤ÑÏä§ Ï¢åÌëúÎ•º ÌôîÎ©¥ Ï¢åÌëúÎ°ú Î≥ÄÌôò
                    const canvasRect = fabricCanvas.getElement().getBoundingClientRect();
                    const objCoords = obj.getBoundingRect();

                    // ÎèÑÌòïÏùò Ïò§Î•∏Ï™Ω Í∞ÄÏû•ÏûêÎ¶¨ ÏúÑÏπò Í≥ÑÏÇ∞
                    const objRightX = canvasRect.left + objCoords.left + objCoords.width;
                    const objTopY = canvasRect.top + objCoords.top;

                    // ÌåùÏóÖ ÌÅ¨Í∏∞ Í≥†Î†§ÌïòÏó¨ ÏúÑÏπò Ï°∞Ï†ï
                    const popupWidth = 180; // ÏòàÏÉÅ ÌåùÏóÖ ÎÑàÎπÑ
                    const popupHeight = 200; // ÏòàÏÉÅ ÌåùÏóÖ ÎÜíÏù¥

                    let left = objRightX + 10; // ÎèÑÌòï Ïò§Î•∏Ï™ΩÏóêÏÑú 10px Îñ®Ïñ¥ÏßÑ ÏúÑÏπò
                    // ÎèÑÌòïÏùò ÏÉÅÌïò Ï§ëÏïôÏóê ÌåùÏóÖ Î∞∞Ïπò
                    let top = objTopY + (objCoords.height / 2) - (popupHeight / 2);

                    // ÌôîÎ©¥ Í≤ΩÍ≥Ñ Ï≤¥ÌÅ¨ - Ïò§Î•∏Ï™ΩÏóê Í≥µÍ∞ÑÏù¥ ÏóÜÏúºÎ©¥ ÏôºÏ™ΩÏóê ÌëúÏãú
                    if (left + popupWidth > window.innerWidth) {
                        left = canvasRect.left + objCoords.left - popupWidth - 10;
                    }
                    // ÌôîÎ©¥ Í≤ΩÍ≥Ñ Ï≤¥ÌÅ¨ - ÏïÑÎûòÏ™ΩÏóê Í≥µÍ∞ÑÏù¥ ÏóÜÏúºÎ©¥ ÏúÑÏ™ΩÏóê ÌëúÏãú
                    if (top + popupHeight > window.innerHeight) {
                        top = objTopY - popupHeight + objCoords.height;
                    }

                    // ÏµúÏÜå ÏúÑÏπò Î≥¥Ïû•
                    left = Math.max(10, left);
                    top = Math.max(10, top);

                    shapeProperties.style.left = left + "px";
                    shapeProperties.style.top = top + "px";
                }
                // 3. ÏúÑÏπò ÏßÄÏ†ï ÌõÑ Î≥¥Ïù¥Í∏∞
                shapeProperties.style.display = "block";
            }
            // windowÏóê ÎÖ∏Ï∂ú
            window.showShapeProperties = showShapeProperties;

            function hideShapeProperties() {
                shapeProperties.style.display = "none";
            }
            // windowÏóê ÎÖ∏Ï∂ú
            window.hideShapeProperties = hideShapeProperties;

            strokeColorInput.addEventListener("change", function () {
                const selectedObjects = fabricCanvas.getActiveObjects();
                if (selectedObjects.length > 0) {
                    selectedObjects.forEach((obj) => {
                        if (obj.type === "textbox") {
                            obj.set("fill", this.value);
                        } else if (
                            obj.type === "group" &&
                            obj.customLabel &&
                            obj.customLabel.startsWith("ÏπòÏàòÏÑ†")
                        ) {
                            // ÏπòÏàòÏÑ† Í∑∏Î£πÏùò Î™®Îì† Í∞ùÏ≤¥Ïóê ÏÉâÏÉÅ Ï†ÅÏö©
                            const groupObjects = obj.getObjects();
                            const groupLeft = obj.left;
                            const groupTop = obj.top;
                            const customLabel = obj.customLabel;

                            // Í∑∏Î£π Ìï¥Ï†ú
                            obj.toActiveSelection();
                            fabricCanvas.discardActiveObject();

                            // Í∞Å Í∞ùÏ≤¥Ïóê ÏÉâÏÉÅ Ï†ÅÏö©
                            groupObjects.forEach((item) => {
                                if (item.type === "line") {
                                    item.set("stroke", this.value);
                                } else if (item.type === "polygon") {
                                    item.set("fill", this.value);
                                }
                            });

                            // Îã§Ïãú Í∑∏Î£πÌôî
                            const newGroup = new fabric.Group(groupObjects, {
                                left: groupLeft,
                                top: groupTop,
                                customLabel: customLabel,
                            });

                            // Í∏∞Ï°¥ Í∞ùÏ≤¥Îì§ Ï†úÍ±∞
                            groupObjects.forEach((item) => fabricCanvas.remove(item));

                            // ÏÉà Í∑∏Î£π Ï∂îÍ∞Ä
                            fabricCanvas.add(newGroup);
                            fabricCanvas.setActiveObject(newGroup);
                        } else if ("stroke" in obj) {
                            obj.set("stroke", this.value);
                        }
                    });
                    fabricCanvas.renderAll();
                    saveHistory();
                }
            });

            strokeColorInput.addEventListener("input", function () {
                const selectedObjects = fabricCanvas.getActiveObjects();
                if (selectedObjects.length > 0) {
                    selectedObjects.forEach((obj) => {
                        if (obj.type === "textbox") {
                            obj.set("fill", this.value);
                        } else if (
                            obj.type === "group" &&
                            obj.customLabel &&
                            obj.customLabel.startsWith("ÏπòÏàòÏÑ†")
                        ) {
                            // ÏπòÏàòÏÑ† Í∑∏Î£πÏùò Î™®Îì† Í∞ùÏ≤¥Ïóê ÏÉâÏÉÅ Ï†ÅÏö©
                            const groupObjects = obj.getObjects();
                            groupObjects.forEach((item) => {
                                if (item.type === "line") {
                                    item.set("stroke", this.value);
                                } else if (item.type === "polygon") {
                                    item.set("fill", this.value);
                                }
                            });
                            // Í∑∏Î£π ÏûêÏ≤¥ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                            obj.setCoords();
                            // Í∞ïÏ†úÎ°ú Ï∫îÎ≤ÑÏä§ Îã§Ïãú Î†åÎçîÎßÅ
                            fabricCanvas.requestRenderAll();
                        } else if ("stroke" in obj) {
                            obj.set("stroke", this.value);
                        }
                    });
                    fabricCanvas.renderAll();
                }
            });

            strokeWidthInput.addEventListener("change", function () {
                const selectedObjects = fabricCanvas.getActiveObjects();
                if (selectedObjects.length > 0) {
                    selectedObjects.forEach((obj) => {
                        if (obj.type === "textbox") {
                            obj.set("fontSize", parseInt(this.value) || 20);
                        } else if ("strokeWidth" in obj && obj.type !== "textbox") {
                            obj.set("strokeWidth", parseInt(this.value));
                        } else if (
                            obj.type === "group" &&
                            obj.customLabel &&
                            obj.customLabel.startsWith("ÏπòÏàòÏÑ†")
                        ) {
                            // ÏπòÏàòÏÑ† Í∑∏Î£πÏùò ÏÑ† Í∞ùÏ≤¥Ïóê ÏÑ† ÎëêÍªò Ï†ÅÏö©
                            obj.getObjects().forEach((item) => {
                                if (item.type === "line") {
                                    item.set("strokeWidth", parseInt(this.value) || 1);
                                }
                            });
                        }
                    });
                    fabricCanvas.renderAll();
                    saveHistory();
                }
            });

            strokeWidthInput.addEventListener("input", function () {
                const selectedObjects = fabricCanvas.getActiveObjects();
                if (selectedObjects.length > 0) {
                    selectedObjects.forEach((obj) => {
                        if (obj.type === "textbox") {
                            obj.set("fontSize", parseInt(this.value) || 20);
                        } else if ("strokeWidth" in obj && obj.type !== "textbox") {
                            obj.set("strokeWidth", parseInt(this.value) || 1);
                        } else if (
                            obj.type === "group" &&
                            obj.customLabel &&
                            obj.customLabel.startsWith("ÏπòÏàòÏÑ†")
                        ) {
                            // ÏπòÏàòÏÑ† Í∑∏Î£πÏùò ÏÑ† Í∞ùÏ≤¥Ïóê ÏÑ† ÎëêÍªò Ï†ÅÏö©
                            obj.getObjects().forEach((item) => {
                                if (item.type === "line") {
                                    item.set("strokeWidth", parseInt(this.value) || 1);
                                }
                            });
                        }
                    });
                    fabricCanvas.renderAll();
                }
            });

            fillColorInput.addEventListener("change", function () {
                const selectedObjects = fabricCanvas.getActiveObjects();
                if (selectedObjects.length > 0) {
                    selectedObjects.forEach((obj) => {
                        if (
                            obj.type !== "line" &&
                            obj.type !== "textbox" &&
                            "fill" in obj
                        ) {
                            obj.set("fill", this.value);
                        }
                    });
                    fabricCanvas.renderAll();
                    saveHistory();
                }
            });

            fillColorInput.addEventListener("input", function () {
                const selectedObjects = fabricCanvas.getActiveObjects();
                if (selectedObjects.length > 0) {
                    selectedObjects.forEach((obj) => {
                        if (
                            obj.type !== "line" &&
                            obj.type !== "textbox" &&
                            "fill" in obj
                        ) {
                            obj.set("fill", this.value);
                        }
                    });
                    fabricCanvas.renderAll();
                }
            });

            dashedToggle.addEventListener("click", function () {
                const selectedObjects = fabricCanvas.getActiveObjects();
                if (selectedObjects.length === 0) return;
                selectedObjects.forEach((obj) => {
                    if (["line", "circle", "rect", "triangle"].includes(obj.type)) {
                        const current = obj.strokeDashArray;
                        let dashArray = null;
                        if (!current) {
                            if (obj.type === "line") dashArray = [10, 5];
                            else dashArray = [8, 4]; // circle, rect, triangle
                        }
                        obj.set("strokeDashArray", dashArray);
                    } else if (
                        obj.type === "group" &&
                        obj.customLabel &&
                        obj.customLabel.startsWith("ÏπòÏàòÏÑ†")
                    ) {
                        // ÏπòÏàòÏÑ† Í∑∏Î£πÏùò ÏÑ† Í∞ùÏ≤¥Ïóê Ï†êÏÑ† Ï†ÅÏö© (Ï∫°ÏùÄ Ï†úÏô∏)
                        obj.getObjects().forEach((item) => {
                            if (item.type === "line") {
                                // Ï∫°(ÏÑ∏Î°úÏÑ†)Ïù∏ÏßÄ ÌôïÏù∏ - isArrowCap ÏÜçÏÑ±ÏúºÎ°ú ÏãùÎ≥Ñ
                                if (item.isArrowCap) {
                                    // Ï∫°ÏùÄ Ïã§ÏÑ† Ïú†ÏßÄ
                                    item.set("strokeDashArray", null);
                                } else {
                                    // Î©îÏù∏ ÏÑ†Îßå Ï†êÏÑ† Ï†ÅÏö©
                                    const current = item.strokeDashArray;
                                    let dashArray = null;
                                    if (!current) {
                                        dashArray = [10, 5];
                                    }
                                    item.set("strokeDashArray", dashArray);
                                }
                            }
                        });
                    }
                });
                fabricCanvas.renderAll();
                saveHistory();

                // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ (Ï≤´ Î≤àÏß∏ Ïò§Î∏åÏ†ùÌä∏ Í∏∞Ï§Ä)
                const obj = selectedObjects[0];
                if (obj && obj.strokeDashArray) {
                    this.textContent = "Ï†êÏÑ†";
                    this.classList.add("active");
                } else if (
                    obj.type === "group" &&
                    obj.customLabel &&
                    obj.customLabel.startsWith("ÏπòÏàòÏÑ†")
                ) {
                    // ÏπòÏàòÏÑ† Í∑∏Î£πÏùò ÏÑ† Í∞ùÏ≤¥ ÌôïÏù∏
                    const lineObj = obj
                        .getObjects()
                        .find((item) => item.type === "line");
                    if (lineObj && lineObj.strokeDashArray) {
                        this.textContent = "Ï†êÏÑ†";
                        this.classList.add("active");
                    } else {
                        this.textContent = "Ïã§ÏÑ†";
                        this.classList.remove("active");
                    }
                } else {
                    this.textContent = "Ïã§ÏÑ†";
                    this.classList.remove("active");
                }
            });

            transparentBtn.addEventListener("click", function () {
                const selectedObjects = fabricCanvas.getActiveObjects();
                if (selectedObjects.length === 0) return;
                selectedObjects.forEach((obj) => {
                    if (obj.type !== "line" && "fill" in obj) {
                        obj.set("fill", "transparent");
                    }
                });
                fabricCanvas.renderAll();
                saveHistory();

                // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                this.classList.add("active");
            });

            // ÌÖçÏä§Ìä∏ Î∞∞Í≤ΩÏÉâ Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏
            textBackgroundColorInput.addEventListener("change", function () {
                const selectedObjects = fabricCanvas.getActiveObjects();
                if (selectedObjects.length > 0) {
                    selectedObjects.forEach((obj) => {
                        if (obj.type === "textbox") {
                            obj.set("backgroundColor", this.value);
                        }
                    });
                    fabricCanvas.renderAll();
                    saveHistory();
                }
            });

            textBackgroundColorInput.addEventListener("input", function () {
                const selectedObjects = fabricCanvas.getActiveObjects();
                if (selectedObjects.length > 0) {
                    selectedObjects.forEach((obj) => {
                        if (obj.type === "textbox") {
                            obj.set("backgroundColor", this.value);
                        }
                    });
                    fabricCanvas.renderAll();
                }
            });

            // ÌÖçÏä§Ìä∏ Î∞∞Í≤Ω Ìà¨Î™Ö Î≤ÑÌäº
            textBackgroundTransparentBtn.addEventListener("click", function () {
                const selectedObjects = fabricCanvas.getActiveObjects();
                if (selectedObjects.length === 0) return;
                selectedObjects.forEach((obj) => {
                    if (obj.type === "textbox") {
                        obj.set("backgroundColor", "transparent");
                    }
                });
                fabricCanvas.renderAll();
                saveHistory();

                // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                this.classList.add("active");
            });

            fabricCanvas.on("selection:created", () => {
                updateLayerList();
            });

            fabricCanvas.on("selection:updated", () => {
                updateLayerList();
            });

            fabricCanvas.on("selection:cleared", () => {
                updateLayerList();
                hideShapeProperties();
            });

            let clipboard = null;

            function copyObjects() {
                const activeObjects = fabricCanvas.getActiveObjects();
                if (activeObjects.length > 0) {
                    clipboard = [];
                    activeObjects.forEach((obj) => {
                        obj.clone((cloned) => {
                            clipboard.push(cloned);
                        });
                    });
                }
            }

            function pasteObjects() {
                if (!clipboard || clipboard.length === 0) return;
                clipboard.forEach((cloneObj) => {
                    cloneObj.clone(function (cloned) {
                        // ÌÉÄÏûÖÎ≥Ñ Ïπ¥Ïö¥ÌÑ∞ Ï¶ùÍ∞Ä Î∞è customLabel Î∂ÄÏó¨
                        if (cloned.type === "line") {
                            objectCounters.line++;
                            cloned.customLabel = "ÏßÅÏÑ†" + objectCounters.line;
                        } else if (cloned.type === "rect") {
                            objectCounters.rect++;
                            cloned.customLabel = "ÏÇ¨Í∞ÅÌòï" + objectCounters.rect;
                        } else if (cloned.type === "triangle") {
                            objectCounters.triangle++;
                            cloned.customLabel = "ÏÇºÍ∞ÅÌòï" + objectCounters.triangle;
                        } else if (cloned.type === "circle") {
                            objectCounters.circle++;
                            cloned.customLabel = "Ïõê" + objectCounters.circle;
                        } else if (cloned.type === "textbox") {
                            objectCounters.textbox++;
                            cloned.customLabel = "ÌÖçÏä§Ìä∏" + objectCounters.textbox;
                        } else if (cloned.type === "path") {
                            objectCounters.pan++;
                            cloned.customLabel = "ÏûêÏú†Í≥°ÏÑ†" + objectCounters.pan;
                        } else if (
                            cloned.type === "group" &&
                            cloned.customLabel &&
                            cloned.customLabel.startsWith("ÏπòÏàòÏÑ†")
                        ) {
                            objectCounters.arrow++;
                            cloned.customLabel = "ÏπòÏàòÏÑ†" + objectCounters.arrow;
                        } else {
                            cloned.customLabel = "Ïù¥Î¶ÑÏóÜÏùå";
                        }
                        cloned.set({
                            left: (cloned.left || 0) + 20,
                            top: (cloned.top || 0) + 20,
                            evented: true,
                        });
                        fabricCanvas.add(cloned);
                        fabricCanvas.setActiveObject(cloned);
                        fabricCanvas.renderAll();
                        saveHistory();
                    });
                });
            }

            // ÌåîÎ†àÌä∏ Î≤ÑÌäº Ïó∞Îèô
            function setupColorPalette(paletteId, inputId, applyColorFn) {
                const palette = document.getElementById(paletteId);
                if (!palette) return;
                palette.querySelectorAll(".color-btn").forEach((btn) => {
                    btn.addEventListener("click", function () {
                        const color = this.getAttribute("data-color");
                        const input = document.getElementById(inputId);
                        if (input) {
                            input.value = color;
                            input.dispatchEvent(new Event("input"));
                        }
                        if (typeof applyColorFn === "function") applyColorFn(color);
                    });
                });
            }

            // ÏÑ† ÏÉâÏÉÅ ÌåîÎ†àÌä∏ Ïó∞Îèô (ÌÖçÏä§Ìä∏Î©¥ Í∏ÄÏûêÏÉâ, ÏïÑÎãàÎ©¥ ÏÑ†ÏÉâ)
            setupColorPalette(
                "strokeColorPalette",
                "strokeColor",
                function (color) {
                    const obj = fabricCanvas.getActiveObject();
                    if (obj) {
                        if (obj.type === "textbox") {
                            obj.set("fill", color);
                        } else {
                            obj.set("stroke", color);
                        }
                        fabricCanvas.renderAll();
                        saveHistory();
                    }
                }
            );

            // Ï±ÑÏö∞Í∏∞ ÏÉâÏÉÅ ÌåîÎ†àÌä∏ Ïó∞Îèô
            setupColorPalette("fillColorPalette", "fillColor", function (color) {
                const obj = fabricCanvas.getActiveObject();
                if (obj && obj.type !== "line") {
                    obj.set("fill", color);
                    fabricCanvas.renderAll();
                    saveHistory();
                }
            });

            // ÏÉâÏÉÅ ÏÑ†ÌÉù ÌÉ≠ Ïó∞Îèô Ìï®Ïàò
            function setupColorTabs(tabGroupId, tabPrefix) {
                const tabs = document.getElementById(tabGroupId);
                if (!tabs) return;
                tabs.querySelectorAll(".tab-btn").forEach((btn) => {
                    btn.addEventListener("click", function () {
                        // Î™®Îì† ÌÉ≠ ÎπÑÌôúÏÑ±Ìôî
                        tabs
                            .querySelectorAll(".tab-btn")
                            .forEach((b) => b.classList.remove("active"));
                        // Î™®Îì† Ïª®ÌÖêÏ∏† Ïà®ÍπÄ
                        ["theme", "standard", "custom"].forEach((tab) => {
                            const content = document.getElementById(tabPrefix + "-" + tab);
                            if (content) content.style.display = "none";
                        });
                        // ÌòÑÏû¨ ÌÉ≠ ÌôúÏÑ±Ìôî Î∞è Ïª®ÌÖêÏ∏† ÌëúÏãú
                        this.classList.add("active");
                        const showContent = document.getElementById(
                            tabPrefix + "-" + this.dataset.tab
                        );
                        if (showContent) showContent.style.display = "";
                    });
                });
            }
            setupColorTabs("strokeColorTabs", "stroke-tab");
            setupColorTabs("fillColorTabs", "fill-tab");

            // ÌåîÎ†àÌä∏ ÌåùÏóÖ show/hide Î∞è ÏÉâÏÉÅ Ïó∞Îèô (ÌÅ¥Î¶≠Îßå, Ìïú Î≤àÏóê ÌïòÎÇòÎßå Ïó¥Î¶º)
            function setupPalettePopup(
                triggerId,
                popupId,
                inputId,
                applyColorFn,
                allPopupIds
            ) {
                const trigger = document.getElementById(triggerId);
                const popup = document.getElementById(popupId);
                const input = document.getElementById(inputId);
                if (!trigger || !popup) return;

                // ÌåùÏóÖ show/hide (ÌÜ†Í∏Ä)
                function showPopup() {
                    // Îã§Î•∏ ÌåîÎ†àÌä∏ Îã´Í∏∞
                    if (Array.isArray(allPopupIds)) {
                        allPopupIds.forEach((id) => {
                            if (id !== popupId) {
                                const el = document.getElementById(id);
                                if (el) el.style.display = "none";
                            }
                        });
                    }
                    if (popup.style.display === "block") {
                        popup.style.display = "none";
                        return;
                    }
                    // ÏúÑÏπò Í≥ÑÏÇ∞: ÌÅ¥Î¶≠Ìïú Î≤ÑÌäº ÏúÑÏπòÏóêÏÑú Î∞îÎ°ú ÌëúÏãú
                    const rect = trigger.getBoundingClientRect();

                    // ÌåîÎ†àÌä∏Î•º bodyÏóê ÏßÅÏ†ë Ï∂îÍ∞ÄÌïòÏó¨ ÏúÑÏπò Í≥ÑÏÇ∞ Ï†ïÌôïÏÑ± Ìñ•ÏÉÅ
                    if (popup.parentNode !== document.body) {
                        document.body.appendChild(popup);
                    }

                    popup.style.position = "fixed";
                    popup.style.zIndex = "10000";

                    // ÌåîÎ†àÌä∏ ÌÅ¨Í∏∞ Í≥†Î†§ÌïòÏó¨ ÏúÑÏπò Ï°∞Ï†ï
                    const popupWidth = 200; // ÌåîÎ†àÌä∏ ÏòàÏÉÅ ÎÑàÎπÑ
                    const popupHeight = 150; // ÌåîÎ†àÌä∏ ÏòàÏÉÅ ÎÜíÏù¥

                    let left = rect.left;
                    let top = rect.bottom + 5;

                    // ÌôîÎ©¥ Í≤ΩÍ≥Ñ Ï≤¥ÌÅ¨
                    if (left + popupWidth > window.innerWidth) {
                        left = rect.right - popupWidth;
                    }
                    if (top + popupHeight > window.innerHeight) {
                        top = rect.top - popupHeight - 5;
                    }

                    // ÏµúÏÜå ÏúÑÏπò Î≥¥Ïû•
                    left = Math.max(10, left);
                    top = Math.max(10, top);

                    popup.style.left = left + "px";
                    popup.style.top = top + "px";
                    popup.style.display = "block";
                }
                function hidePopup() {
                    popup.style.display = "none";
                    // ÌåîÎ†àÌä∏Î•º ÏõêÎûò ÏúÑÏπòÎ°ú ÎêòÎèåÎ¶¨Í∏∞
                    const originalParent = document.querySelector('#shapeProperties .property-group');
                    if (originalParent && popup.parentNode === document.body) {
                        originalParent.appendChild(popup);
                    }
                }
                trigger.addEventListener("click", function (e) {
                    e.stopPropagation();
                    showPopup();
                });

                // Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
                document.addEventListener("mousedown", function (e) {
                    if (!popup.contains(e.target) && e.target !== trigger) {
                        hidePopup();
                    }
                });

                // ÏÉâÏÉÅ ÏÑ†ÌÉù Ïó∞Îèô
                popup.querySelectorAll(".color-btn").forEach((btn) => {
                    btn.addEventListener("click", function () {
                        const color = this.getAttribute("data-color");
                        if (input) {
                            input.value = color;
                            input.dispatchEvent(new Event("input"));
                        }
                        if (typeof applyColorFn === "function") applyColorFn(color);
                        hidePopup();
                    });
                });
            }

            // Î™®Îì† ÌåîÎ†àÌä∏ id Î™©Î°ù
            const allPopupIds = [
                "strokeThemePalette",
                "strokeStandardPalette",
                "fillThemePalette",
                "fillStandardPalette",
                "textBackgroundThemePalette",
                "textBackgroundStandardPalette",
            ];

            // ÏÑ† ÏÉâÏÉÅ
            setupPalettePopup(
                "strokeThemeBtn",
                "strokeThemePalette",
                "strokeColor",
                function (color) {
                    const obj = fabricCanvas.getActiveObject();
                    if (obj) {
                        if (obj.type === "textbox") {
                            obj.set("fill", color);
                        } else {
                            obj.set("stroke", color);
                        }
                        fabricCanvas.renderAll();
                        saveHistory();
                    }
                },
                allPopupIds
            );
            setupPalettePopup(
                "strokeStandardBtn",
                "strokeStandardPalette",
                "strokeColor",
                function (color) {
                    const obj = fabricCanvas.getActiveObject();
                    if (obj) {
                        if (obj.type === "textbox") {
                            obj.set("fill", color);
                        } else {
                            obj.set("stroke", color);
                        }
                        fabricCanvas.renderAll();
                        saveHistory();
                    }
                },
                allPopupIds
            );
            // Ï±ÑÏö∞Í∏∞ ÏÉâÏÉÅ
            setupPalettePopup(
                "fillThemeBtn",
                "fillThemePalette",
                "fillColor",
                function (color) {
                    const obj = fabricCanvas.getActiveObject();
                    if (obj && obj.type !== "line") {
                        obj.set("fill", color);
                        fabricCanvas.renderAll();
                        saveHistory();
                    }
                },
                allPopupIds
            );
            setupPalettePopup(
                "fillStandardBtn",
                "fillStandardPalette",
                "fillColor",
                function (color) {
                    const obj = fabricCanvas.getActiveObject();
                    if (obj && obj.type !== "line") {
                        obj.set("fill", color);
                        fabricCanvas.renderAll();
                        saveHistory();
                    }
                },
                allPopupIds
            );

            // ÌÖçÏä§Ìä∏ Î∞∞Í≤ΩÏÉâ ÌåîÎ†àÌä∏
            setupPalettePopup(
                "textBackgroundThemeBtn",
                "textBackgroundThemePalette",
                "textBackgroundColor",
                function (color) {
                    const obj = fabricCanvas.getActiveObject();
                    if (obj && obj.type === "textbox") {
                        obj.set("backgroundColor", color);
                        fabricCanvas.renderAll();
                        saveHistory();
                    }
                },
                allPopupIds
            );
            setupPalettePopup(
                "textBackgroundStandardBtn",
                "textBackgroundStandardPalette",
                "textBackgroundColor",
                function (color) {
                    const obj = fabricCanvas.getActiveObject();
                    if (obj && obj.type === "textbox") {
                        obj.set("backgroundColor", color);
                        fabricCanvas.renderAll();
                        saveHistory();
                    }
                },
                allPopupIds
            );

            // Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Í∏∞Îä•
            document
                .getElementById("bgImageInput")
                .addEventListener("change", function (e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = function (evt) {
                        // Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ Î≥ÄÍ≤Ω Ïãú Î†àÏù¥Ïñ¥ Ï¥àÍ∏∞Ìôî
                        clearLayers();
                        fabric.Image.fromURL(evt.target.result, function (img) {
                            fabricCanvas.setBackgroundImage(
                                img,
                                function () {
                                    fitImageToContainer();
                                    lastSavedJSON = JSON.stringify(fabricCanvas.toJSON());
                                    history.push(fabricCanvas.toJSON());
                                },
                                {
                                    scaleX: 1,
                                    scaleY: 1,
                                }
                            );
                        });
                    };
                    reader.readAsDataURL(file);
                });

            function clearLayers() {
                // Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄÎäî ÎÇ®Í∏∞Í≥† Ïò§Î∏åÏ†ùÌä∏Îßå ÏÇ≠Ï†ú
                fabricCanvas
                    .getObjects()
                    .slice()
                    .forEach((obj) => fabricCanvas.remove(obj));
                fabricCanvas.discardActiveObject();
                fabricCanvas.renderAll();
                saveHistory();
                updateLayerList();
                hideShapeProperties();
            }
            // windowÏóê ÎÖ∏Ï∂ú
            window.clearLayers = clearLayers;

            // Î†àÏù¥Ïñ¥ ÏàúÏÑú Ï°∞Ï†ï Í∏∞Îä•
            document.getElementById("bringToFrontBtn").onclick = function () {
                fabricCanvas
                    .getActiveObjects()
                    .forEach((obj) => fabricCanvas.bringToFront(obj));
                fabricCanvas.renderAll();
                updateLayerList();
            };
            document.getElementById("sendToBackBtn").onclick = function () {
                fabricCanvas
                    .getActiveObjects()
                    .forEach((obj) => fabricCanvas.sendToBack(obj));
                fabricCanvas.renderAll();
                updateLayerList();
            };

            // Îã®Ï∂ïÌÇ§ ÎèÑÏõÄÎßê Ìà¥ÌåÅ ÏúÑÏπò Ï°∞Ï†ï
            function adjustTooltipPosition() {
                const shortcutHelp = document.querySelector(".shortcut-help");
                const tooltip = document.querySelector(".shortcut-tooltip");

                if (!shortcutHelp || !tooltip) return;

                shortcutHelp.addEventListener("mouseenter", function () {
                    // ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ ÏúÑÏπò Í≥ÑÏÇ∞ (Î†åÎçîÎßÅ ÏôÑÎ£å ÎåÄÍ∏∞)
                    setTimeout(() => {
                        const helpRect = shortcutHelp.getBoundingClientRect();
                        const tooltipRect = tooltip.getBoundingClientRect();
                        const viewportWidth = window.innerWidth;
                        const viewportHeight = window.innerHeight;

                        // Í∏∞Î≥∏ ÏúÑÏπò (Ï§ëÏïô Ï†ïÎ†¨)
                        let left = "50%";
                        let transform = "translateX(-50%)";

                        // Ïò§Î•∏Ï™ΩÏúºÎ°ú ÎÑòÏñ¥Í∞ÄÎäî Í≤ΩÏö∞
                        if (helpRect.left + tooltipRect.width / 2 > viewportWidth) {
                            left = "auto";
                            tooltip.style.right = "0";
                            transform = "none";
                        }

                        // ÏôºÏ™ΩÏúºÎ°ú ÎÑòÏñ¥Í∞ÄÎäî Í≤ΩÏö∞
                        if (helpRect.left - tooltipRect.width / 2 < 0) {
                            left = "0";
                            tooltip.style.right = "auto";
                            transform = "none";
                        }

                        // ÏïÑÎûòÏ™ΩÏúºÎ°ú ÎÑòÏñ¥Í∞ÄÎäî Í≤ΩÏö∞ (ÏúÑÏ™ΩÏóê ÌëúÏãú)
                        if (helpRect.bottom + tooltipRect.height + 20 > viewportHeight) {
                            tooltip.style.top = "auto";
                            tooltip.style.bottom = "100%";
                            tooltip.style.marginTop = "0";
                            tooltip.style.marginBottom = "8px";
                            tooltip.style.setProperty("--arrow-direction", "bottom");
                        } else {
                            tooltip.style.top = "100%";
                            tooltip.style.bottom = "auto";
                            tooltip.style.marginTop = "8px";
                            tooltip.style.marginBottom = "0";
                            tooltip.style.setProperty("--arrow-direction", "top");
                        }

                        tooltip.style.left = left;
                        tooltip.style.transform = transform;
                    }, 50);
                });
            }

            // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ìà¥ÌåÅ ÏúÑÏπò Ï°∞Ï†ï Ï¥àÍ∏∞Ìôî
            document.addEventListener("DOMContentLoaded", function () {
                adjustTooltipPosition();

                // Ï¥àÍ∏∞ Ïä§ÌÅ¨Î°§ ÏÑ§Ï†ï
                const container = document.getElementById("container");
                const containerWidth = container.clientWidth;
                const containerHeight = container.clientHeight;

                // Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞Ïóê Îî∞Îùº Ïä§ÌÅ¨Î°§ ÌïÑÏöî Ïó¨Î∂Ä ÌôïÏù∏ (Ïó¨Ïú† Í≥µÍ∞Ñ 20px)
                if (
                    fabricCanvas.width > containerWidth - 20 ||
                    fabricCanvas.height > containerHeight - 20
                ) {
                    container.classList.add("scrollable");
                } else {
                    container.classList.remove("scrollable");
                }

                // Ï¥àÍ∏∞ÏóêÎäî Ïä§ÌÅ¨Î°§ Ï†úÍ±∞
                setTimeout(() => {
                    container.classList.remove("scrollable");
                }, 100);
            });
        })();

        // Î™®Îã¨ Ïó¥Í∏∞
        function openSaveModal() {
            document.getElementById("saveModal").style.display = "block";
            document.getElementById("fabricFileName").focus();
            const fabricBack = document.getElementById("fabric-back");
            if (fabricBack) fabricBack.style.display = "block";
        }

        // Î™®Îã¨ Îã´Í∏∞
        function closeSaveModal() {
            document.getElementById("saveModal").style.display = "none";
            const fabricBack = document.getElementById("fabric-back");
            if (fabricBack) fabricBack.style.display = "none";
        }

        // ÌÇ§Î≥¥Îìú Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
        function fabricHandleKeyDown(event) {
            // ESC ÌÇ§Î°ú ÏÑ†ÌÉù Ìï¥Ï†ú
            if (event.key === 'Escape') {
                fabricCanvas.discardActiveObject();
                fabricCanvas.renderAll();
            }
            // Delete ÌÇ§Î°ú ÏÑ†ÌÉùÎêú Í∞ùÏ≤¥ ÏÇ≠Ï†ú
            else if (event.key === 'Delete' || event.key === 'Backspace') {
                const activeObjects = fabricCanvas.getActiveObjects();
                if (activeObjects.length > 0) {
                    fabricCanvas.remove(...activeObjects);
                    fabricCanvas.discardActiveObject();
                    fabricCanvas.renderAll();
                }
            }
        }

        // Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû•
        function downloadCanvasImage() {
            const fabricFileNameInput = document.getElementById("fabricFileName");
            let fabricFileName = fabricFileNameInput ? fabricFileNameInput.value : "";
            if (fabricType == "d_img_storage") {
                fabricDImageAdd(fabricFileName);
            } else if (fabricType == "d_cross_section_storage") {
                fabricDCrossImageAdd(fabricFileName);
            }

            closeSaveModal();

            // popup_close ÏöîÏÜåÍ∞Ä Ï°¥Ïû¨Ìï† ÎïåÎßå ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ïã§Ìñâ
            const popupClose = document.getElementById('popup_close');
            if (popupClose) {
                popupClose.click();
            }

            document.removeEventListener("keydown", fabricHandleKeyDown);
            showTopToast(fabricFileName + " Ïù¥ÎØ∏ÏßÄÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!");
        }

        // ÏßÄÎèÑ ÏòÅÏó≠ Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ìï®Ïàò (Ïô∏Î∂ÄÏóêÏÑú Ìò∏Ï∂ú)
        function loadMapAreaImage(imageDataURL) {
            try {
                if (fabricCanvas && fabric) {
                    // 1. Í∏∞Ï°¥ Ï∫îÎ≤ÑÏä§ ÎÇ¥Ïö©Îßå Ï¥àÍ∏∞Ìôî (Ï∫îÎ≤ÑÏä§ Ïû¨ÏÉùÏÑ±ÌïòÏßÄ ÏïäÏùå)
                    fabricCanvas.clear();
                    fabricCanvas.setBackgroundImage(null, fabricCanvas.renderAll.bind(fabricCanvas));

                    // 2. Î™®Îì† Í∞ùÏ≤¥ Ï†úÍ±∞
                    fabricCanvas.getObjects().forEach(obj => {
                        fabricCanvas.remove(obj);
                    });

                    // 3. Ï∫îÎ≤ÑÏä§ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
                    fabricCanvas.discardActiveObject();
                    fabricCanvas.renderAll();

                    // 4. Ï∫îÎ≤ÑÏä§ Ï¢åÌëúÍ≥Ñ Ï¥àÍ∏∞Ìôî
                    fabricCanvas.setViewportTransform([1, 0, 0, 1, 0, 0]);
                    fabricCanvas.setZoom(1);
                    // setPanÏùÄ ÏßÄÏõêÎêòÏßÄ ÏïäÏúºÎØÄÎ°ú Ï†úÍ±∞

                    // 5. Ïù¥ÎØ∏ÏßÄ Î°úÎìú
                    loadImageToCanvas(imageDataURL);
                } else {
                    console.error('Fabric.js Ï∫îÎ≤ÑÏä§Í∞Ä ÏïÑÏßÅ Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);
            }
        }

        // Ïù¥ÎØ∏ÏßÄÎ•º Ï∫îÎ≤ÑÏä§Ïóê Î°úÎìúÌïòÎäî Î≥ÑÎèÑ Ìï®Ïàò
        function loadImageToCanvas(imageDataURL) {
            try {
                // Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ï†Ñ Í≤ÄÏ¶ù
                if (!imageDataURL || imageDataURL === '' || imageDataURL === 'data:,' || imageDataURL.length < 100) {
                    console.error('Ïù¥ÎØ∏ÏßÄ Îç∞Ïù¥ÌÑ∞ URLÏù¥ Ïú†Ìö®ÌïòÏßÄ ÏïäÏäµÎãàÎã§:', imageDataURL ? imageDataURL.substring(0, 50) + '...' : 'null');
                    hideLoadingMessage();
                    alert('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Ïù¥ÎØ∏ÏßÄ Îç∞Ïù¥ÌÑ∞ÏûÖÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }

                console.log('Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏãúÏûë, URL Í∏∏Ïù¥:', imageDataURL.length);

                // Î°úÎî© Î©îÏãúÏßÄ ÌëúÏãú
                showLoadingMessage('Ï∫°Ï≤ò Ïù¥ÎØ∏ÏßÄÎ•º Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§...');

                // Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÌÉÄÏûÑÏïÑÏõÉ ÏÑ§Ï†ï
                const loadTimeout = setTimeout(() => {
                    console.error('Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÌÉÄÏûÑÏïÑÏõÉ');
                    hideLoadingMessage();
                }, 10000); // 10Ï¥à ÌÉÄÏûÑÏïÑÏõÉ

                // Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïû¨ÏãúÎèÑ Î°úÏßÅ
                let retryCount = 0;
                const maxRetries = 5; // Ïû¨ÏãúÎèÑ ÌöüÏàò Ï¶ùÍ∞Ä

                function attemptImageLoad() {
                    console.log(`Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏãúÎèÑ ${retryCount + 1}/${maxRetries + 1}`);

                    // Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ï†Ñ Ï∂îÍ∞Ä Í≤ÄÏ¶ù
                    if (!imageDataURL || imageDataURL.length < 100) {
                        console.error('Ïù¥ÎØ∏ÏßÄ Îç∞Ïù¥ÌÑ∞Í∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
                        if (retryCount < maxRetries) {
                            retryCount++;
                            setTimeout(attemptImageLoad, 1000);
                            return;
                        } else {
                            clearTimeout(loadTimeout);
                            hideLoadingMessage();
                            alert('Ïù¥ÎØ∏ÏßÄ Î°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                            return;
                        }
                    }

                    fabric.Image.fromURL(imageDataURL, function (img) {
                        clearTimeout(loadTimeout);
                        hideLoadingMessage(); // Î°úÎî© Î©îÏãúÏßÄ Ïà®Í∏∞Í∏∞

                        if (img && img.width > 0 && img.height > 0) {
                            console.log('Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏÑ±Í≥µ:', img.width, 'x', img.height);

                            // ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞ Ï†ÄÏû•
                            fabricImgWidth = img.width;
                            fabricImgHeight = img.height;
                            console.log('ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞ Ï†ÄÏû•:', fabricImgWidth, 'x', fabricImgHeight);

                            // Ïù¥ÎØ∏ÏßÄ ÎπÑÏú® Ïú†ÏßÄÌïòÎ©¥ÏÑú Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ Ï°∞Ï†ï
                            const container = document.getElementById("container");
                            const containerWidth = container.clientWidth - 40; // Ïó¨Î∞± Í≥†Î†§
                            const containerHeight = container.clientHeight - 40;

                            // Ïù¥ÎØ∏ÏßÄ ÎπÑÏú® Í≥ÑÏÇ∞
                            const imageRatio = img.width / img.height;
                            const containerRatio = containerWidth / containerHeight;

                            let canvasWidth, canvasHeight;

                            // ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞ Ïö∞ÏÑ† ÏÇ¨Ïö©
                            canvasWidth = img.width;
                            canvasHeight = img.height;

                            // Ïª®ÌÖåÏù¥ÎÑàÎ•º Î≤óÏñ¥ÎÇòÏßÄ ÏïäÎèÑÎ°ù Ï°∞Ï†ï
                            if (canvasWidth > containerWidth) {
                                canvasWidth = containerWidth;
                                canvasHeight = canvasWidth / imageRatio;
                            }
                            if (canvasHeight > containerHeight) {
                                canvasHeight = containerHeight;
                                canvasWidth = canvasHeight * imageRatio;
                            }

                            // ÏõêÎ≥∏ ÌÅ¨Í∏∞ Ïú†ÏßÄ (ÏµúÏÜå ÌÅ¨Í∏∞ ÌôïÎåÄ Ï†úÍ±∞)
                            console.log('ÏõêÎ≥∏ ÌÅ¨Í∏∞ Ïú†ÏßÄ:', canvasWidth, 'x', canvasHeight);

                            // Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ ÏÑ§Ï†ï
                            fabricCanvas.setWidth(canvasWidth);
                            fabricCanvas.setHeight(canvasHeight);

                            // Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ ÏÑ§Ï†ï
                            fabricCanvas.setBackgroundImage(img, function () {
                                console.log('Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ ÏÑ§Ï†ï ÏôÑÎ£å');

                                try {
                                    // Ï∫îÎ≤ÑÏä§ Ïª®ÌÖåÏù¥ÎÑà Ïä§ÌÉÄÏùº Ï°∞Ï†ï
                                    const canvasContainer = document.querySelector('.canvas-container');
                                    if (canvasContainer) {
                                        canvasContainer.style.width = canvasWidth + 'px';
                                        canvasContainer.style.height = canvasHeight + 'px';
                                        canvasContainer.style.margin = 'auto';
                                    }

                                    // Ïä§ÌÅ¨Î°§ ÏÑ§Ï†ï
                                    if (canvasWidth > containerWidth || canvasHeight > containerHeight) {
                                        container.classList.add("scrollable");
                                    } else {
                                        container.classList.remove("scrollable");
                                    }

                                    // Ï∫îÎ≤ÑÏä§ Ï¢åÌëúÍ≥Ñ Ïû¨ÏÑ§Ï†ï
                                    setTimeout(() => {
                                        fabricCanvas.calcOffset();
                                        fabricCanvas.renderAll();

                                        console.log('Ï∫îÎ≤ÑÏä§ ÏÑ§Ï†ï ÏôÑÎ£å');
                                        console.log('Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞:', fabricCanvas.width, 'x', fabricCanvas.height);

                                        // Î°úÎî© Î©îÏãúÏßÄ Ïà®Í∏∞Í∏∞
                                        hideLoadingMessage();

                                        // Î¶¨ÏÇ¨Ïù¥Ï¶à Ìï∏Îì§ ÌëúÏãú
                                        setTimeout(() => {
                                            if (window.updateResizeHandlePosition) {
                                                window.updateResizeHandlePosition();
                                            }
                                            // Î¶¨ÏÇ¨Ïù¥Ï¶à Ìï∏Îì§ ÏÉùÏÑ± Î∞è ÌëúÏãú
                                            if (window.createResizeHandle) {
                                                window.createResizeHandle();
                                            }
                                        }, 200);
                                    }, 100);
                                } catch (error) {
                                    console.error('Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ ÏÑ§Ï†ï ÌõÑ Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò:', error);
                                }
                            }, {
                                scaleX: canvasWidth / img.width,
                                scaleY: canvasHeight / img.height
                            });
                        } else {
                            console.error('Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå® ÎòêÎäî Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Ïù¥ÎØ∏ÏßÄ');
                            if (retryCount < maxRetries) {
                                retryCount++;
                                console.log(`${retryCount}Ï¥à ÌõÑ Ïû¨ÏãúÎèÑ...`);
                                setTimeout(() => {
                                    attemptImageLoad();
                                }, retryCount * 1000);
                            } else {
                                console.error('ÏµúÎåÄ Ïû¨ÏãúÎèÑ ÌöüÏàò Ï¥àÍ≥º, fallback ÏÇ¨Ïö©');
                                clearTimeout(loadTimeout);
                                hideLoadingMessage();
                                // ÎåÄÏ≤¥ Î∞©Î≤ï: ÏßÅÏ†ë Ïù¥ÎØ∏ÏßÄ ÏöîÏÜå ÏÉùÏÑ±
                                loadImageWithFallback(imageDataURL);
                            }
                        }
                    }, {
                        crossOrigin: 'anonymous'
                    });
                }

                // Ï≤´ Î≤àÏß∏ ÏãúÎèÑ
                attemptImageLoad();
            } catch (error) {
                console.error('Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);
                hideLoadingMessage();
                alert('Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
            }
        }

        // ÎåÄÏ≤¥ Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ìï®Ïàò
        function loadImageWithFallback(imageDataURL) {
            console.log('ÎåÄÏ≤¥ Î∞©Î≤ïÏúºÎ°ú Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏãúÎèÑ');

            const imgElement = new Image();
            imgElement.crossOrigin = 'anonymous';

            const fallbackTimeout = setTimeout(() => {
                console.error('ÎåÄÏ≤¥ Î∞©Î≤ï Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÌÉÄÏûÑÏïÑÏõÉ');
                hideLoadingMessage();
                alert('Ïù¥ÎØ∏ÏßÄ Î°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
            }, 8000); // ÌÉÄÏûÑÏïÑÏõÉ ÏãúÍ∞Ñ Ï¶ùÍ∞Ä

            imgElement.onload = function () {
                clearTimeout(fallbackTimeout);
                hideLoadingMessage(); // Î°úÎî© Î©îÏãúÏßÄ Ïà®Í∏∞Í∏∞
                console.log('ÎåÄÏ≤¥ Î∞©Î≤ïÏúºÎ°ú Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏÑ±Í≥µ:', imgElement.width, 'x', imgElement.height);

                // ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞ Ï†ÄÏû•
                fabricImgWidth = imgElement.width;
                fabricImgHeight = imgElement.height;
                console.log('ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞ Ï†ÄÏû• (fallback):', fabricImgWidth, 'x', fabricImgHeight);

                try {
                    // Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ Ï°∞Ï†ï
                    const container = document.getElementById("container");
                    const containerWidth = container.clientWidth - 40;
                    const containerHeight = container.clientHeight - 40;

                    const imageRatio = imgElement.width / imgElement.height;
                    const containerRatio = containerWidth / containerHeight;

                    let canvasWidth, canvasHeight;

                    // ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞ Ïö∞ÏÑ† ÏÇ¨Ïö©
                    canvasWidth = imgElement.width;
                    canvasHeight = imgElement.height;

                    // Ïª®ÌÖåÏù¥ÎÑàÎ•º Î≤óÏñ¥ÎÇòÏßÄ ÏïäÎèÑÎ°ù Ï°∞Ï†ï
                    if (canvasWidth > containerWidth) {
                        canvasWidth = containerWidth;
                        canvasHeight = canvasWidth / imageRatio;
                    }
                    if (canvasHeight > containerHeight) {
                        canvasHeight = containerHeight;
                        canvasWidth = canvasHeight * imageRatio;
                    }

                    // ÏõêÎ≥∏ ÌÅ¨Í∏∞ Ïú†ÏßÄ (fallback, ÏµúÏÜå ÌÅ¨Í∏∞ ÌôïÎåÄ Ï†úÍ±∞)
                    console.log('ÏõêÎ≥∏ ÌÅ¨Í∏∞ Ïú†ÏßÄ (fallback):', canvasWidth, 'x', canvasHeight);

                    // ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞ Ï†ÄÏû• (fallback)
                    fabricImgWidth = imgElement.width;
                    fabricImgHeight = imgElement.height;
                    console.log('ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞ Ï†ÄÏû• (fallback):', fabricImgWidth, 'x', fabricImgHeight);

                    // Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ ÏÑ§Ï†ï
                    fabricCanvas.setWidth(canvasWidth);
                    fabricCanvas.setHeight(canvasHeight);

                    // Fabric Ïù¥ÎØ∏ÏßÄ Í∞ùÏ≤¥ ÏÉùÏÑ±
                    const fabricImg = new fabric.Image(imgElement, {
                        scaleX: canvasWidth / imgElement.width,
                        scaleY: canvasHeight / imgElement.height,
                        left: 0,
                        top: 0,
                        selectable: false,
                        evented: false
                    });

                    // Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄÎ°ú ÏÑ§Ï†ï
                    fabricCanvas.setBackgroundImage(fabricImg, function () {
                        fabricCanvas.renderAll();
                        console.log('ÎåÄÏ≤¥ Î∞©Î≤ï Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ ÏÑ§Ï†ï ÏôÑÎ£å');
                    });

                } catch (error) {
                    console.error('ÎåÄÏ≤¥ Î∞©Î≤ï Ïù¥ÎØ∏ÏßÄ Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò:', error);
                }
            };

            imgElement.onerror = function () {
                clearTimeout(fallbackTimeout);
                console.error('ÎåÄÏ≤¥ Î∞©Î≤ïÏúºÎ°úÎèÑ Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®');
            };

            imgElement.src = imageDataURL;
        }

        // Ï∫îÎ≤ÑÏä§ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï Ìï®Ïàò
        function setupCanvasEventListeners() {
            try {
                // Ï∫îÎ≤ÑÏä§ÏôÄ DOM ÏöîÏÜå ÌôïÏù∏
                if (!fabricCanvas) {
                    console.error('Ï∫îÎ≤ÑÏä§Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                    return;
                }

                if (!fabricCanvas.upperCanvasEl || !fabricCanvas.lowerCanvasEl) {
                    console.error('Ï∫îÎ≤ÑÏä§ DOM ÏöîÏÜåÍ∞Ä Ïó∞Í≤∞ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                    return;
                }

                // Í∏∞Ï°¥ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†úÍ±∞
                fabricCanvas.off('mouse:down');
                fabricCanvas.off('mouse:up');
                fabricCanvas.off('mouse:move');
                fabricCanvas.off('mouse:wheel');

                // ÎßàÏö∞Ïä§ Ïù¥Î≤§Ìä∏ Ïû¨Îì±Î°ù
                fabricCanvas.on('mouse:down', function (opt) {
                    const pointer = fabricCanvas.getPointer(opt.e);
                    console.log('ÎßàÏö∞Ïä§ Îã§Ïö¥ Ï¢åÌëú:', pointer);
                });

                fabricCanvas.on('mouse:up', function (opt) {
                    const pointer = fabricCanvas.getPointer(opt.e);
                    console.log('ÎßàÏö∞Ïä§ ÏóÖ Ï¢åÌëú:', pointer);
                });

                fabricCanvas.on('mouse:move', function (opt) {
                    // ÎßàÏö∞Ïä§ Ïù¥Îèô Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
                });

                // Ìú† Ïù¥Î≤§Ìä∏ Ïû¨Îì±Î°ù
                fabricCanvas.on('mouse:wheel', function (opt) {
                    const delta = opt.e.deltaY;
                    let zoom = fabricCanvas.getZoom();
                    zoom *= 0.999 ** delta;
                    if (zoom > 20) zoom = 20;
                    if (zoom < 0.01) zoom = 0.01;
                    fabricCanvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, zoom);
                    opt.e.preventDefault();
                    opt.e.stopPropagation();
                });

                console.log('Ï∫îÎ≤ÑÏä§ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ïû¨Îì±Î°ù ÏôÑÎ£å');
            } catch (error) {
                console.error('Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï Ï§ë Ïò§Î•ò:', error);
            }
        }

        // Î°úÎî© Î©îÏãúÏßÄ ÌëúÏãú Ìï®Ïàò
        function showLoadingMessage(message) {
            console.log('Î°úÎî© Î©îÏãúÏßÄ ÌëúÏãú ÏãúÏûë:', message);

            // Í∏∞Ï°¥ Î°úÎî© Î©îÏãúÏßÄ Ï†úÍ±∞
            hideLoadingMessage();

            // Ï∫îÎ≤ÑÏä§ Ïª®ÌÖåÏù¥ÎÑà Ï∞æÍ∏∞ (Ïó¨Îü¨ Î∞©Î≤ï ÏãúÎèÑ)
            let canvasContainer = document.getElementById('canvasContainer');
            if (!canvasContainer) {
                canvasContainer = document.querySelector('.canvas-container');
                console.log('canvas-container ÌÅ¥ÎûòÏä§ Ï∞æÍ∏∞:', canvasContainer);
            }
            if (!canvasContainer) {
                canvasContainer = document.querySelector('#canvas');
                console.log('canvas ÏöîÏÜå Ï∞æÍ∏∞:', canvasContainer);
            }
            if (!canvasContainer) {
                canvasContainer = document.querySelector('canvas');
                console.log('canvas ÌÉúÍ∑∏ Ï∞æÍ∏∞:', canvasContainer);
            }
            if (!canvasContainer) {
                canvasContainer = document.getElementById('container');
                console.log('container ÏöîÏÜå Ï∞æÍ∏∞:', canvasContainer);
            }

            if (!canvasContainer) {
                console.error('Ï∫îÎ≤ÑÏä§ Ïª®ÌÖåÏù¥ÎÑàÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Ï†ÑÏ≤¥ ÌôîÎ©¥Ïóê ÌëúÏãúÌï©ÎãàÎã§.');
                // Ï†ÑÏ≤¥ ÌôîÎ©¥Ïóê ÌëúÏãú
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loading-message';
                loadingDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.85);
                    color: white;
                    padding: 15px 25px;
                    border-radius: 6px;
                    font-size: 14px;
                    z-index: 10000;
                    text-align: center;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
                    pointer-events: none;
                    min-width: 200px;
                    border: 1px solid rgba(255, 255, 255, 0.1);
                `;
                loadingDiv.innerHTML = `
                    <div style="margin-bottom: 8px; font-size: 18px;">‚è≥</div>
                    <div style="font-weight: 500;">${message}</div>
                `;
                document.body.appendChild(loadingDiv);
                return;
            }

            console.log('Ï∫îÎ≤ÑÏä§ Ïª®ÌÖåÏù¥ÎÑà Ï∞æÏùå:', canvasContainer);

            // Î°úÎî© Î©îÏãúÏßÄ ÏÉùÏÑ±
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-message';
            loadingDiv.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(30, 41, 59, 0.9);
                color: white;
                padding: 20px 30px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 1000;
                text-align: center;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                pointer-events: none;
                min-width: 200px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
            `;
            loadingDiv.innerHTML = `
                <div style="margin-bottom: 8px; font-size: 18px; animation: spin 1s linear infinite;">‚è≥</div>
                <div style="font-weight: 500;">${message}</div>
            `;

            // Ï∫îÎ≤ÑÏä§ Ïª®ÌÖåÏù¥ÎÑàÏóê ÏÉÅÎåÄÏ†Å ÏúÑÏπòÎ°ú Ï∂îÍ∞Ä
            canvasContainer.style.position = 'relative';
            canvasContainer.appendChild(loadingDiv);

            console.log('Î°úÎî© Î©îÏãúÏßÄ Ï∂îÍ∞Ä ÏôÑÎ£å');
        }

        // Î°úÎî© Î©îÏãúÏßÄ Ïà®Í∏∞Í∏∞ Ìï®Ïàò
        function hideLoadingMessage() {
            const loadingDiv = document.getElementById('loading-message');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞ Î°úÎî© Î©îÏãúÏßÄ ÌëúÏãú
        document.addEventListener('DOMContentLoaded', function () {
            showLoadingMessage('Ìé∏ÏßëÍ∏∞Î•º Ï§ÄÎπÑÌïòÎäî Ï§ëÏûÖÎãàÎã§...');
        });

        // Ï†ÑÏó≠ Ìï®ÏàòÎ°ú ÎÖ∏Ï∂ú
        window.loadMapAreaImage = loadMapAreaImage;
        window.fabric = fabric;
        window.canvas = fabricCanvas;
        window.setupCanvasEventListeners = setupCanvasEventListeners;
        window.showLoadingMessage = showLoadingMessage;
        window.hideLoadingMessage = hideLoadingMessage;
        window.updateResizeHandlePosition = updateResizeHandlePosition;
        window.createResizeHandle = createResizeHandle;
    </script>
</body>

</html>